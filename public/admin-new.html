<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Live Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6F6158;
            --secondary: #2bbd7e;
            --purple: #5e35b1;
            --text-dark: #333;
            --text-light: #777;
            --bg-light: #f5f5f5;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --pending: #ff3b30;
            --completed: #34c759;
            --waiting: #ffc107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            background-color: #f8f9fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 0;
        }

        /* Conversation Tabs */
        .conversation-tabs {
            display: flex;
            background-color: var(--purple);
            color: white;
            margin-bottom: 0;
            border-bottom: none;
        }

        .tab {
            padding: 15px 25px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            position: relative;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .count {
            display: inline-block;
            background-color: white;
            color: var(--purple);
            border-radius: 12px;
            padding: 0 8px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0;
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .search-bar {
            width: 60%;
            display: flex;
            align-items: center;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 0 15px;
            box-shadow: none;
        }

        .search-bar i {
            color: var(--text-light);
            margin-right: 10px;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 0;
            border: none;
            outline: none;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            color: var(--text-dark);
        }

        .filter-btn:hover {
            background-color: var(--bg-light);
        }

        .filter-btn i {
            margin-right: 8px;
            color: var(--text-dark);
        }

        /* Conversation Table */
        .conversation-table {
            background-color: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            margin-bottom: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 500;
            color: var(--text-dark);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 14px;
        }

        tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* สถานะ */
        .status {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.pending {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--pending);
        }

        .status.pending::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--pending);
            border-radius: 50%;
            margin-right: 5px;
        }

        .status.completed {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--completed);
        }

        .status.completed::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--completed);
            border-radius: 50%;
            margin-right: 5px;
        }

        /* ปุ่ม */
        .action-btn {
            padding: 8px 16px;
            background-color: white;
            color: var(--purple);
            border: 1px solid var(--purple);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .action-btn:hover {
            background-color: var(--purple);
            color: white;
        }

        /* Chat Panel */
        .chat-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 5px var(--shadow);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--purple);
            color: white;
        }

        .customer-info {
            display: flex;
            align-items: center;
        }

        .customer-info h3 {
            font-size: 16px;
            font-weight: 500;
        }

        .customer-info p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-actions button {
            background: none;
            border: none;
            font-size: 16px;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }

        .admin-status-btn {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-status-btn.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: white;
        }

        /* แก้ไข CSS โดยสลับฝั่ง user กับ admin/bot */
        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 85%;
            width: 100%;
            clear: both;
        }

        /* ข้อความของผู้ใช้ (user) แสดงที่ฝั่งซ้าย */
        .message.user {
            float: left;
            margin-right: auto;
            margin-left: 0;
            flex-direction: row; /* ทิศทางปกติ */
        }

        /* ข้อความของบอทและแอดมินแสดงที่ฝั่งขวา */
        .message.bot, .message.admin {
            float: right;
            margin-left: auto;
            margin-right: 0;
            flex-direction: row-reverse; /* กลับทิศทาง */
        }

        /* สไตล์ข้อความ */
        .message-content {
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            max-width: 80%;
        }

        /* สไตล์ข้อความผู้ใช้ (อยู่ซ้าย) */
        .message.user .message-content {
            background-color: #f5f5f5;
            color: #333;
            border-top-left-radius: 4px;
            margin-right: auto; /* ย้ายไปทางซ้าย */
        }

        /* สไตล์ข้อความแอดมิน (อยู่ขวา) */
        .message.admin .message-content {
            background-color: #8e44ad; /* สีม่วง */
            color: white;
            border-top-right-radius: 4px;
            margin-left: auto; /* ย้ายไปทางขวา */
        }

        /* สไตล์ข้อความบอท (อยู่ขวา) */
        .message.bot .message-content {
             background-color: #f5f5f5;
            border-top-right-radius: 4px;
            margin-left: auto; /* ย้ายไปทางขวา */
        }

        /* ข้อความระบบ (อยู่ตรงกลาง) */
        .message.system {
            width: 100%;
            display: flex;
            justify-content: center;
            max-width: 100%;
        }

        .message.system .message-content {
            background-color: #f0f0f0;
            font-size: 12px;
            text-align: center;
            color: #666;
            max-width: 70%;
        }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            background-color: var(--purple);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
        }

        /* Socket Status */
        .socket-status {
            display: inline-block;
            margin-right: 15px;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .socket-status.connected {
            background-color: rgba(43, 189, 126, 0.2);
            color: #2bbd7e;
        }

        .socket-status.disconnected {
            background-color: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        /* การแจ้งเตือน */
        .admin-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(43, 189, 126, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .admin-notification.fade-out {
            animation: fadeOut 0.5s ease forwards;
        }

        .admin-notification.error {
            background-color: rgba(255, 59, 48, 0.9);
        }

        /* Rich Content Styles */
        .rich-content-container {
            margin-top: 10px;
        }

        .rich-info {
            background-color: #f5f5f5;
            border-left: 3px solid #5e35b1;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .rich-info h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .rich-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .rich-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .rich-button {
            background-color: #5e35b1;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 13px;
            cursor: pointer;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .rich-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .rich-chip {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 13px;
            color: #333;
        }

        .rich-image {
            margin-bottom: 8px;
            text-align: center;
        }

        .rich-image img {
            max-width: 100%;
            border-radius: 8px;
            max-height: 200px;
        }

        .property-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .property-image {
            height: 120px;
            position: relative;
            overflow: hidden;
        }

        .property-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .property-info {
            padding: 10px;
        }

        .property-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .property-location {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .property-price {
            font-size: 16px;
            font-weight: bold;
            color: #5e35b1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .search-filter {
                flex-direction: column;
            }

            .search-bar {
                width: 100%;
                margin-bottom: 10px;
            }

            .filter-btn {
                width: 100%;
                justify-content: center;
            }

            .chat-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="admin-container">
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="admin-header" style="padding: 10px 20px; background-color: #5e35b1; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 20px;">แอดมินแชท</h1>
            <div class="header-actions">
                <!-- สถานะการเชื่อมต่อ Socket.IO -->
                <div id="socket-status" class="socket-status">
                    กำลังเชื่อมต่อ...
                </div>
            </div>
        </header>

        <!-- Conversation Tabs -->
        <div class="conversation-tabs">
            <a href="#" class="tab active" data-status="all">
                ทั้งหมด
                <span class="count all-count">(0)</span>
            </a>
            <a href="#" class="tab" data-status="waiting">
                รอตอบกลับ
                <span class="count waiting-count">(0)</span>
            </a>
            <a href="#" class="tab" data-status="answered">
                ตอบแล้ว
                <span class="count answered-count">(0)</span>
            </a>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="ค้นหาตามชื่อ หรือเบอร์โทร">
            </div>
            <button class="filter-btn" id="filter-btn">
                <i class="fas fa-filter"></i>
                ตัวกรอง
            </button>
        </div>

        <!-- Conversation Table -->
        <div class="conversation-table">
            <table>
                <thead>
                <tr>
                    <th>ชื่อ</th>
                    <th>เวลาติดต่อ</th>
                    <th>ข้อความล่าสุด</th>
                    <th>ติดต่อ</th>
                    <th>สถานะ</th>
                    <th>การดำเนินการ</th>
                </tr>
                </thead>
                <tbody id="conversation-list">
                <!-- รายการการสนทนาจะแสดงที่นี่ -->
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูลการสนทนา...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="customer-info">
                <div id="chat-customer-name">ลูกค้า</div>
                <p id="chat-customer-contact">เยี่ยมชมเว็บไซต์</p>
            </div>
            <div class="chat-actions">
                <button id="admin-status-btn" class="admin-status-btn">เปิดใช้งานแอดมิน</button>
                <button class="close-chat-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="chat-messages" id="adminChatMessages">
            <!-- ข้อความจะแสดงที่นี่ -->
        </div>

        <div class="chat-input-area">
            <input type="text" id="admin-chat-input" placeholder="พิมพ์ข้อความ...">
            <button class="send-btn" id="admin-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="/socket.io/socket.io.js"></script>
<script>
    // สถานะของแอดมิน
    const adminState = {
        currentSessionId: null,
        isOpen: false,
        conversations: {},
        socket: null,
        adminInfo: {
            id: 'admin1',
            name: 'แอดมิน'
        },
        adminActive: false,
        currentWebId: '001', // Web ID สำหรับใช้กับ API
        apiBaseUrl: 'https://9751-58-8-179-158.ngrok-free.app/api/v1', // เพิ่ม Base URL สำหรับ API
        apiToken: 'd734ce5c4be61d6d7a311044bad0ef447630f25fe0f31e70628699938aa2ca96' // เพิ่ม Bearer Token

    };

    // DOM Elements
    const elements = {
        tabButtons: document.querySelectorAll('.tab'),
        conversationList: document.getElementById('conversation-list'),
        searchInput: document.getElementById('search-input'),
        filterBtn: document.getElementById('filter-btn'),

        chatPanel: document.getElementById('chatPanel'),
        closeChatBtn: document.querySelector('.close-chat-btn'),
        chatCustomerName: document.getElementById('chat-customer-name'),
        chatCustomerContact: document.getElementById('chat-customer-contact'),

        adminSendBtn: document.getElementById('admin-send-btn'),
        adminChatInput: document.getElementById('admin-chat-input'),
        adminChatMessages: document.getElementById('adminChatMessages'),

        socketStatus: document.getElementById('socket-status'),
        adminStatusBtn: document.getElementById('admin-status-btn'),

        waitingCount: document.querySelector('.waiting-count'),
        answeredCount: document.querySelector('.answered-count'),
        allCount: document.querySelector('.all-count')
    };

    // เชื่อมต่อ Socket.IO
    function connectSocket() {
        try {
            const socketUrl = window.location.origin;

            adminState.socket = io(socketUrl);

            adminState.socket.on('connect', () => {
                console.log('เชื่อมต่อกับ Socket.IO สำเร็จ:', adminState.socket.id);

                if (elements.socketStatus) {
                    elements.socketStatus.textContent = 'เชื่อมต่อแล้ว';
                    elements.socketStatus.classList.add('connected');
                    elements.socketStatus.classList.remove('disconnected');
                }

                // ร้องขอเข้าร่วมทุกห้อง (เฉพาะแอดมิน)
                adminState.socket.emit('join_all_rooms');

                // โหลดรายการการสนทนาทั้งหมด
                loadConversations();
            });

            // รับข้อความใหม่
            adminState.socket.on('new_message', (data) => {
                console.log('ได้รับข้อความใหม่:', data);

                // อัปเดตการสนทนาในรายการ
                updateConversationInList(data);

                // ถ้าเป็นห้องที่กำลังดูอยู่ ให้แสดงข้อความ
                if (data.room === adminState.currentSessionId) {
                    addMessageToChat(data);
                } else {
                    // ถ้าเป็นห้องอื่น แสดงการแจ้งเตือน
                    if (data.sender === 'user') {
                        showNotification(`มีข้อความใหม่จากผู้ใช้ในห้อง ${data.room}`);
                    }
                }
            });

            // รับการแจ้งเตือนเมื่อมีผู้ใช้ต้องการติดต่อแอดมิน
            adminState.socket.on('user_request_agent', (data) => {
                console.log('ผู้ใช้ต้องการติดต่อแอดมิน:', data);

                showNotification(`ผู้ใช้ ${data.userInfo?.name || 'ไม่ระบุชื่อ'} ต้องการติดต่อแอดมิน`);

                // อัปเดตรายการการสนทนา
                loadConversations();
            });

            // รับการแจ้งเตือนการเปลี่ยนสถานะแอดมิน
            adminState.socket.on('admin_status_change', (data) => {
                console.log('การเปลี่ยนสถานะแอดมิน:', data);

                if (data.room === adminState.currentSessionId) {
                    adminState.adminActive = data.adminActive;
                    updateAdminStatusBtn();
                }
            });

            // เมื่อตัดการเชื่อมต่อ
            adminState.socket.on('disconnect', () => {
                console.log('ตัดการเชื่อมต่อจาก Socket.IO');

                if (elements.socketStatus) {
                    elements.socketStatus.textContent = 'ขาดการเชื่อมต่อ';
                    elements.socketStatus.classList.add('disconnected');
                    elements.socketStatus.classList.remove('connected');
                }
            });

            return true;
        } catch (error) {
            console.error('เกิดข้อผิดพลาดในการเชื่อมต่อ Socket.IO:', error);
            return false;
        }
    }

    // โหลดรายการการสนทนาทั้งหมด
    // โหลดรายการการสนทนาทั้งหมดจาก API
function loadConversations() {
  console.log('กำลังโหลดรายการการสนทนา...');

    const apiUrl = `${adminState.apiBaseUrl}/chat/lists?web_id=${adminState.currentWebId}`;

  fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${adminState.apiToken}` // เพิ่ม Bearer Token ในส่วน headers
        }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success" && Array.isArray(data.rooms)) {
        console.log('โหลดการสนทนาสำเร็จ:', data.rooms.length, 'รายการ');

        // แปลงข้อมูลจาก API เป็นรูปแบบที่ต้องการใช้
        data.rooms.forEach(room => {
          const lastMessage = room.messages && room.messages.length > 0
              ? room.messages[0]
              : null;

          adminState.conversations[room.room_id] = {
            sessionId: room.room_id,
            roomId: room.room_id,
            webId: adminState.currentWebId,
            userInfo: room.contact_info || {},
            status: room.status_reply ? 'answered' : 'waiting',
            lastActivity: room.updatetime || Date.now(),
            lastMessage: lastMessage ? {
              text: lastMessage.message,
              sender: lastMessage.sender,
              timestamp: lastMessage.create_date
            } : null
          };
        });

        // อัปเดตและแสดงผล
        updateConversationCounts(Object.values(adminState.conversations));
        renderConversationList();
      } else {
        console.error('ข้อมูลไม่ถูกต้องหรือไม่พบการสนทนา');
        elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ไม่พบข้อมูลการสนทนา</td></tr>';
      }
    })
    .catch(error => {
      console.error('เกิดข้อผิดพลาดในการโหลดการสนทนา:', error);
      elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
    });
}

    // อัปเดตจำนวนการสนทนาในแต่ละแท็บ
    function updateConversationCounts(conversations) {
        const waitingCount = conversations.filter(conv => conv.status === 'waiting').length;
        const answeredCount = conversations.filter(conv => conv.status === 'answered').length;
        const totalCount = conversations.length;

        if (elements.waitingCount) elements.waitingCount.textContent = `(${waitingCount})`;
        if (elements.answeredCount) elements.answeredCount.textContent = `(${answeredCount})`;
if (elements.allCount) elements.allCount.textContent = `(${totalCount})`;
}

// แสดงรายการการสนทนา
function renderConversationList() {
    // ดึงสถานะแท็บที่กำลังเลือกอยู่
    const activeTab = document.querySelector('.tab.active');
    const currentStatus = activeTab ? activeTab.dataset.status : 'all';

    // ดึงข้อความค้นหา
    const searchText = elements.searchInput.value.trim().toLowerCase();

    // กรองการสนทนาตามสถานะและข้อความค้นหา
    let filteredConversations = Object.values(adminState.conversations);

    if (currentStatus !== 'all') {
        filteredConversations = filteredConversations.filter(conv => conv.status === currentStatus);
    }

    if (searchText) {
        filteredConversations = filteredConversations.filter(conv => {
            const userInfo = conv.userInfo || {};
            const name = (userInfo.name || '').toLowerCase();
            const email = (userInfo.email || '').toLowerCase();
            const phone = (userInfo.phone || '').toLowerCase();
            const lastMessage = conv.lastMessage && conv.lastMessage.text ? conv.lastMessage.text.toLowerCase() : '';

            return name.includes(searchText) ||
                   email.includes(searchText) ||
                   phone.includes(searchText) ||
                   lastMessage.includes(searchText);
        });
    }

    // เรียงลำดับตามเวลาล่าสุด
    filteredConversations.sort((a, b) => b.lastActivity - a.lastActivity);

    // สร้าง HTML
    if (filteredConversations.length === 0) {
        elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ไม่พบข้อมูลการสนทนาที่ตรงกับเงื่อนไข</td></tr>';
        return;
    }

    let html = '';

    filteredConversations.forEach(conv => {
        const userInfo = conv.userInfo || {};
        const name = userInfo.name || 'ไม่ระบุชื่อ';
        const email = userInfo.email || '-';
        const phone = userInfo.phone || '-';

        // จัดรูปแบบเวลา
        const lastActivityDate = new Date(conv.lastActivity);
        const formattedDate = `${lastActivityDate.toLocaleDateString('th-TH')}<br>${lastActivityDate.toLocaleTimeString('th-TH')}`;

        // ข้อความล่าสุด
        let lastMessageText = '-';
        if (conv.lastMessage && conv.lastMessage.text) {
            lastMessageText = `"${conv.lastMessage.text.substring(0, 30)}${conv.lastMessage.text.length > 30 ? '...' : ''}"`;
        }

        // สถานะ
        const statusClass = conv.status === 'waiting' ? 'pending' : 'completed';
        const statusText = conv.status === 'waiting' ? 'รอตอบกลับ' : 'ตอบแล้ว';

        html += `
            <tr>
                <td>${escapeHTML(name)}</td>
                <td>${formattedDate}</td>
                <td>${escapeHTML(lastMessageText)}</td>
                <td>${escapeHTML(phone)}<br>${escapeHTML(email)}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td><button class="action-btn chat-btn" data-id="${conv.sessionId}">คุยต่อเลย</button></td>
            </tr>
        `;
    });

    elements.conversationList.innerHTML = html;

    // เพิ่ม Event Listeners สำหรับปุ่มแชท
    document.querySelectorAll('.chat-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.dataset.id;
            openChatSession(sessionId);
        });
    });
}

// เปิดห้องแชท
function openChatSession(sessionId) {
  function openChatSession(sessionId) {
  console.log('เปิดห้องแชท:', sessionId);

  // ดึงข้อมูลห้องแชทจาก state
  const conversation = adminState.conversations[sessionId];
  if (!conversation) {
    console.error('ไม่พบข้อมูลการสนทนา:', sessionId);
    showNotification('ไม่พบข้อมูลการสนทนา กำลังโหลดใหม่...', 'error');

    // พยายามโหลดข้อมูลใหม่ก่อนเปิดห้องแชท
    loadConversations().then(() => {
      // ตรวจสอบอีกครั้งหลังโหลดข้อมูลใหม่
      if (adminState.conversations[sessionId]) {
        openChatSession(sessionId); // เรียกตัวเองอีกครั้งหลังโหลดข้อมูลใหม่
      }
    });
    return;
  }


  const roomId = conversation.roomId || sessionId;
  const webId = conversation.webId || adminState.currentWebId;

  // บันทึก sessionId และ roomId ปัจจุบัน
  adminState.currentSessionId = sessionId;
  adminState.currentRoomId = roomId;

  // แสดงหน้าต่างแชท
  elements.chatPanel.style.display = 'flex';
  elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">กำลังโหลดข้อความ...</div>';

  // เรียก API เพื่อโหลดประวัติการสนทนา
    const apiUrl = `${adminState.apiBaseUrl}/chat/open?web_id=${webId}&room_id=${roomId}`;

  fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${adminState.apiToken}` // เพิ่ม Bearer Token ในส่วน headers
        }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        console.log('โหลดข้อมูลการสนทนาสำเร็จ');

        // อัปเดตข้อมูลลูกค้า
        const userInfo = data.contact_info || {};
        const name = userInfo.name || 'ไม่ระบุชื่อ';
        const email = userInfo.email || '';
        const phone = userInfo.phone || '';
        const contact = [email, phone].filter(Boolean).join(' • ') || 'ไม่มีข้อมูลติดต่อ';

        elements.chatCustomerName.textContent = name;
        elements.chatCustomerContact.textContent = contact;

        // อัปเดตสถานะแอดมิน
        adminState.adminActive = data.status_reply === 1;
        updateAdminStatusBtn();

        // แสดงประวัติการสนทนา
        if (data.messages && data.messages.length > 0) {
          displayChatHistory(data.messages);
        } else {
          elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">ยังไม่มีข้อความในการสนทนานี้</div>';
        }
      } else {
        elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:red;">ไม่พบข้อมูลการสนทนา</div>';
      }
    })
    .catch(error => {
      console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลการสนทนา:', error);
      elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
    });

  // เข้าร่วมห้องแชท (ใช้ Socket.IO)
  if (adminState.socket) {
    console.log('เข้าร่วมห้อง:', sessionId);
    adminState.socket.emit('join', sessionId);
  }
}

// แสดงประวัติการสนทนา
function displayChatHistory(messages) {

  if (!messages || messages.length === 0) {
    elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">ยังไม่มีข้อความในการสนทนานี้</div>';
    return;
  }

  messages.forEach(msg => {
    // แปลงข้อมูลให้ตรงกับรูปแบบที่ใช้ในฟังก์ชัน addMessageToChat
    const messageData = {
      sender: msg.sender,
      text: msg.message || '', // รองรับทั้ง message และ text
      timestamp: msg.create_date,
      adminName: msg.adminName || (msg.sender === 'admin' ? adminState.adminInfo.name : undefined),
      room: adminState.currentSessionId
    };

    // ตรวจสอบข้อมูลเพิ่มเติม (เช่น item_list สำหรับแสดงรายการอสังหาริมทรัพย์)
    if (msg.type === 3 && msg.item_list && Array.isArray(msg.item_list)) {
      messageData.payload = {
        richContent: [
          [
            {
              type: "info",
              title: msg.message || "รายการอสังหาริมทรัพย์",
              subtitle: `พบทั้งหมด ${msg.item_list.length} รายการ`
            },
            ...msg.item_list.map(item => ({
              type: "custom_card",
              property_data: {
                id: item.web_id,
                imageUrl: item.photo || '',
                title: item.name || 'ไม่ระบุชื่อ',
                location: item.zone_name || 'ไม่ระบุที่ตั้ง',
                price: item.price || '-',
                tag: item.tag || 'ขาย',
                link: item.link || '#'
              }
            }))
          ]
        ]
      };

      // เพิ่มปุ่ม "ดูเพิ่มเติม" ถ้ามี
      if (msg.more && msg.more.link) {
        messageData.payload.richContent[0].push({
          type: "button",
          options: [
            {
              text: msg.more.txt || "ดูเพิ่มเติม",
              link: msg.more.link
            }
          ]
        });
      }
    } else if (msg.type === 2 && msg.options && Array.isArray(msg.options)) {
      // แสดงตัวเลือกเป็น chips
      messageData.payload = {
        richContent: [
          [
            {
              type: "chips",
              options: msg.options.map(option => ({ text: option }))
            }
          ]
        ]
      };
    }

    addMessageToChat(messageData);
  });

  // เลื่อนไปที่ข้อความล่าสุด
  scrollToBottom();
}

function addMessageToChat(data) {
    // ตรวจสอบว่าเป็นข้อความซ้ำหรือไม่
    if (isMessageDuplicate(data.timestamp)) {
        console.log('ข้อความซ้ำ ไม่แสดงซ้ำ');
        return;
    }

    // สร้าง element ใหม่สำหรับข้อความ
    const messageDiv = document.createElement('div');

    // กำหนด class ตามประเภทผู้ส่ง
    if (data.sender === 'user') {
        messageDiv.className = 'message user'; // ผู้ใช้ฝั่งขวา
    } else if (data.sender === 'bot') {
        messageDiv.className = 'message bot'; // บอทฝั่งซ้าย
    } else if (data.sender === 'admin') {
        messageDiv.className = 'message admin'; // แอดมินฝั่งซ้าย
    } else if (data.sender === 'system') {
        messageDiv.className = 'message system'; // ข้อความระบบตรงกลาง
    }

    // ตั้งค่า attribute สำหรับเช็คข้อความซ้ำ
    messageDiv.setAttribute('data-message-id', data.timestamp);

    // สร้างเนื้อหาข้อความตามประเภทผู้ส่ง
    let messageHTML = '';

    if (data.sender === 'user') {
        // ข้อความจากผู้ใช้
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
            </div>
        `;
    } else if (data.sender === 'bot') {
        // ข้อความจากบอท
        let richContentHtml = '';
        if (data.payload) {
            richContentHtml = renderRichContent(data.payload);
        }

        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
                ${richContentHtml}
                <small>ส่งโดย : บอท</small>

            </div>
        `;
    } else if (data.sender === 'admin') {
        // ข้อความจากแอดมิน
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
                <small>ส่งโดย : ${escapeHTML(data.adminName || adminState.adminInfo.name)}</small>
            </div>
        `;
    } else if (data.sender === 'system') {
        // ข้อความจากระบบ
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
            </div>
        `;
    }

    // ใส่เนื้อหาข้อความ
    messageDiv.innerHTML = messageHTML;

    // เพิ่มข้อความลงในพื้นที่แชท
    elements.adminChatMessages.appendChild(messageDiv);

    // เลื่อนไปที่ข้อความล่าสุด
    scrollToBottom();
}

// ตรวจสอบข้อความซ้ำ
function isMessageDuplicate(messageId) {
    return document.querySelector(`.message[data-message-id="${messageId}"]`) !== null;
}

// เลื่อนหน้าต่างแชทไปที่ล่างสุด
function scrollToBottom() {
    elements.adminChatMessages.scrollTop = elements.adminChatMessages.scrollHeight;
}

// ปิดหน้าต่างแชท
function closeChatPanel() {
    // ออกจากห้องแชท
    if (adminState.currentSessionId && adminState.socket) {
        adminState.socket.emit('leave', adminState.currentSessionId);
        console.log('ออกจากห้อง:', adminState.currentSessionId);
    }

    adminState.currentSessionId = null;
    elements.chatPanel.style.display = 'none';
}

// ส่งข้อความจากแอดมิน// ส่งข้อความจากแอดมิน
function sendAdminMessage() {
  const message = elements.adminChatInput.value.trim();
  if (!message || !adminState.currentSessionId) return;

  const timestamp = Date.now();
  const roomId = adminState.currentRoomId || adminState.currentSessionId;
  const webId = adminState.currentWebId;

  // แสดงข้อความในหน้าต่างแชท
  addMessageToChat({
    sender: 'admin',
    text: message,
    adminName: adminState.adminInfo.name,
    timestamp: timestamp,
    room: adminState.currentSessionId
  });

  // เตรียมข้อมูลสำหรับส่ง API
  const formData = new FormData();
  formData.append('room_id', roomId);
  formData.append('web_id', webId);
  formData.append('detail', message);
  formData.append('type', '1'); // ประเภทข้อความปกติ
  formData.append('sender', 'admin');
  formData.append('options', ''); // ไม่มีตัวเลือกเพิ่มเติม

  // ส่งข้อความผ่าน API
  fetch(`${adminState.apiBaseUrl}/send/sms`, {
    method: 'POST',
        headers: {
            'Authorization': `Bearer ${adminState.apiToken}` // เพิ่ม Bearer Token ในส่วน headers
        },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    console.log('ส่งข้อความผ่าน API สำเร็จ:', data);

    // อัปเดตสถานะ conversation ในรายการเป็น 'answered'
    if (adminState.conversations[adminState.currentSessionId]) {
      adminState.conversations[adminState.currentSessionId].status = 'answered';
      renderConversationList();
    }
  })
  .catch(error => {
    console.error('เกิดข้อผิดพลาดในการส่งข้อความผ่าน API:', error);
    showNotification('เกิดข้อผิดพลาดในการส่งข้อความ', 'error');
  });

  // ส่งข้อความผ่าน Socket.IO ด้วย (ถ้าต้องการ)
  if (adminState.socket) {
    adminState.socket.emit('new_message', {
      sender: 'admin',
      text: message,
      adminId: adminState.adminInfo.id,
      adminName: adminState.adminInfo.name,
      timestamp: timestamp,
      room: adminState.currentSessionId
    });
  }

  // เคลียร์ช่องข้อความ
  elements.adminChatInput.value = '';
  elements.adminChatInput.focus();
}

// สลับสถานะแอดมิน
function toggleAdminStatus() {
    if (!adminState.currentSessionId) return;

    adminState.adminActive = !adminState.adminActive;
    updateAdminStatusBtn();

    // ส่งการเปลี่ยนสถานะไปยัง Socket.IO
    if (adminState.socket) {
        adminState.socket.emit('admin_status_change', {
            type: 'admin_status_change',
            adminActive: adminState.adminActive,
            timestamp: Date.now(),
            room: adminState.currentSessionId,
            adminId: adminState.adminInfo.id,
            adminName: adminState.adminInfo.name
        });
    }

    // แสดงการแจ้งเตือน
    showNotification(`สถานะแอดมิน: ${adminState.adminActive ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}`);
}

// อัปเดตปุ่มสถานะแอดมิน
function updateAdminStatusBtn() {
    if (adminState.adminActive) {
        elements.adminStatusBtn.textContent = 'แอดมินกำลังให้บริการ';
        elements.adminStatusBtn.classList.add('active');
    } else {
        elements.adminStatusBtn.textContent = 'เปิดใช้งานแอดมิน';
        elements.adminStatusBtn.classList.remove('active');
    }
}

// อัปเดตการสนทนาในรายการเมื่อได้รับข้อความใหม่
function updateConversationInList(data) {
    if (!data || !data.room) return;

    // อัปเดตหรือสร้างข้อมูลการสนทนาใหม่
    if (!adminState.conversations[data.room]) {
        adminState.conversations[data.room] = {
            sessionId: data.room,
            userInfo: { name: 'ไม่ระบุชื่อ' },
            status: data.sender === 'user' ? 'waiting' : 'answered',
            lastActivity: data.timestamp || Date.now(),
            lastMessage: {
                text: data.text,
                sender: data.sender,
                timestamp: data.timestamp || Date.now()
            }
        };
    } else {
        // อัปเดตข้อมูลที่มีอยู่แล้ว
        adminState.conversations[data.room].lastActivity = data.timestamp || Date.now();
        adminState.conversations[data.room].lastMessage = {
            text: data.text,
            sender: data.sender,
            timestamp: data.timestamp || Date.now()
        };

        // อัปเดตสถานะ
        if (data.sender === 'user') {
            adminState.conversations[data.room].status = 'waiting';
        } else if (data.sender === 'admin') {
            adminState.conversations[data.room].status = 'answered';
        }
    }

    // อัปเดตการแสดงผล
    updateConversationCounts(Object.values(adminState.conversations));
    renderConversationList();
}

// รองรับการแสดง Rich Content
function renderRichContent(payload) {
    if (!payload || !payload.richContent || !payload.richContent.length) {
        return '';
    }

    let html = '<div class="rich-content-container">';

    payload.richContent[0].forEach(item => {
        if (item.type === 'info') {
            html += `
                <div class="rich-info">
                    <h4>${escapeHTML(item.title || '')}</h4>
                    <p>${escapeHTML(item.subtitle || '')}</p>
                </div>
            `;
        } else if (item.type === 'button') {
            html += '<div class="rich-buttons">';
            if (item.options && Array.isArray(item.options)) {
                item.options.forEach(btn => {
                    html += `<button class="rich-button">${escapeHTML(btn.text || 'Button')}</button>`;
                });
            } else if (item.text) {
                html += `<button class="rich-button">${escapeHTML(item.text)}</button>`;
            }
            html += '</div>';
        } else if (item.type === 'chips') {
            html += '<div class="rich-chips">';
            if (item.options && Array.isArray(item.options)) {
                item.options.forEach(chip => {
                    html += `<span class="rich-chip">${escapeHTML(chip.text || '')}</span>`;
                });
            }
            html += '</div>';
        } else if (item.type === 'image') {
            const imgSrc = item.rawUrl || (item.image && item.image.src ? item.image.src.rawUrl : '');
            if (imgSrc) {
                html += `<div class="rich-image"><img src="${escapeHTML(imgSrc)}" alt="Image"></div>`;
            }
        } else if (item.type === 'custom_card' && item.property_data) {
            const propData = item.property_data;
            html += `
                <div class="property-card">
                    <div class="property-image">
                        <img src="${escapeHTML(propData.imageUrl || '')}" alt="Property">
                        <div class="property-tag">${escapeHTML(propData.tag || 'ขาย')}</div>
                    </div>
                    <div class="property-info">
                        <div class="property-title">${escapeHTML(propData.title || 'ไม่ระบุชื่อ')}</div>
                        <div class="property-location">${escapeHTML(propData.location || 'ไม่ระบุที่ตั้ง')}</div>
                        <div class="property-price">฿${escapeHTML(propData.price || '-')}</div>
                    </div>
                </div>
            `;
        }
    });

    html += '</div>';
    return html;
}

// แสดงการแจ้งเตือน
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `admin-notification ${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}

// ป้องกัน XSS
function escapeHTML(text) {
    if (!text) return '';
    return text
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// เริ่มต้นการทำงาน
function init() {
    // เชื่อมต่อ Socket.IO
    connectSocket();

    // ตั้งค่า event listeners

    // การคลิกแท็บ
    elements.tabButtons.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();

            // ลบคลาส active จากทุกแท็บ
            elements.tabButtons.forEach(t => t.classList.remove('active'));

            // เพิ่มคลาส active ให้แท็บที่คลิก
            this.classList.add('active');

            // เรียกใช้การแสดงรายการการสนทนาตามแท็บที่เลือก
            renderConversationList();
        });
    });

    // การค้นหา
    elements.searchInput.addEventListener('input', function() {
        renderConversationList();
    });

    // การส่งข้อความ
    elements.adminSendBtn.addEventListener('click', sendAdminMessage);

    // การกด Enter ในช่องข้อความ
    elements.adminChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendAdminMessage();
        }
    });

    // การปิดหน้าต่างแชท
    elements.closeChatBtn.addEventListener('click', closeChatPanel);

    // การสลับสถานะแอดมิน
    elements.adminStatusBtn.addEventListener('click', toggleAdminStatus);

    // โหลดรายการการสนทนาเริ่มต้น
    loadConversations();

    // ตั้งเวลาโหลดข้อมูลใหม่ทุก 30 วินาที
    setInterval(loadConversations, 3000);
}

// เริ่มทำงานเมื่อโหลดหน้าเสร็จ
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
