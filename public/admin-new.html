<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Live Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6F6158;
            --secondary: #2bbd7e;
            --purple: #5e35b1;
            --text-dark: #333;
            --text-light: #777;
            --bg-light: #f5f5f5;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --pending: #ff3b30;
            --completed: #34c759;
            --waiting: #ffc107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            background-color: #f8f9fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 0;
        }

        /* Conversation Tabs */
        .conversation-tabs {
            display: flex;
            background-color: var(--purple);
            color: white;
            margin-bottom: 0;
            border-bottom: none;
        }

        .tab {
            padding: 15px 25px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            position: relative;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .count {
            display: inline-block;
            background-color: white;
            color: var(--purple);
            border-radius: 12px;
            padding: 0 8px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0;
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .search-bar {
            width: 60%;
            display: flex;
            align-items: center;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 0 15px;
            box-shadow: none;
        }

        .search-bar i {
            color: var(--text-light);
            margin-right: 10px;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 0;
            border: none;
            outline: none;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            color: var(--text-dark);
        }

        .filter-btn:hover {
            background-color: var(--bg-light);
        }

        .filter-btn i {
            margin-right: 8px;
            color: var(--text-dark);
        }

        /* Conversation Table */
        .conversation-table {
            background-color: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            margin-bottom: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 500;
            color: var(--text-dark);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 14px;
        }

        tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .status {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.pending {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--pending);
        }

        .status.pending::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--pending);
            border-radius: 50%;
            margin-right: 5px;
        }

        .status.completed {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--completed);
        }

        .status.completed::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--completed);
            border-radius: 50%;
            margin-right: 5px;
        }

        /* ‡∏õ‡∏∏‡πà‡∏° */
        .action-btn {
            padding: 8px 16px;
            background-color: white;
            color: var(--purple);
            border: 1px solid var(--purple);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .action-btn:hover {
            background-color: var(--purple);
            color: white;
        }




        .chat-actions button {
            background: none;
            border: none;
            font-size: 16px;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }

        .admin-status-btn {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-status-btn.active {
            background-color: rgba(255, 255, 255, 0.3);
        }



        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS ‡πÇ‡∏î‡∏¢‡∏™‡∏•‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á user ‡∏Å‡∏±‡∏ö admin/bot */
        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 85%;
            width: 100%;
            clear: both;
        }

        /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (user) ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
        .message.user {
            float: left;
            margin-right: auto;
            margin-left: 0;
            flex-direction: row; /* ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ */
        }

        /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ */
        .message.bot, .message.admin {
            float: right;
            margin-left: auto;
            margin-right: 0;
            flex-direction: row-reverse; /* ‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á */
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
        .message-content {
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            max-width: 80%;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢) */
        .message.user .message-content {
            background-color: #f5f5f5;
            color: #333;
            border-top-left-radius: 4px;
            margin-right: auto; /* ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤) */
        .message.admin .message-content {
            background-color: #8e44ad; /* ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á */
            color: white;
            border-top-right-radius: 4px;
            margin-left: auto; /* ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏ó (‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤) */
        .message.bot .message-content {
             background-color: #f5f5f5;
            border-top-right-radius: 4px;
            margin-left: auto; /* ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
        }

        /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á) */
        .message.system {
            width: 100%;
            display: flex;
            justify-content: center;
            max-width: 100%;
        }

        .message.system .message-content {
            background-color: #f0f0f0;
            font-size: 12px;
            text-align: center;
            color: #666;
            max-width: 70%;
        }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            background-color: var(--purple);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
        }

        /* Socket Status */
        .socket-status {
            display: inline-block;
            margin-right: 15px;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .socket-status.connected {
            background-color: rgba(43, 189, 126, 0.2);
            color: #2bbd7e;
        }

        .socket-status.disconnected {
            background-color: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        /* ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
        .admin-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(43, 189, 126, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .admin-notification.fade-out {
            animation: fadeOut 0.5s ease forwards;
        }

        .admin-notification.error {
            background-color: rgba(255, 59, 48, 0.9);
        }

        /* Rich Content Styles */
        .rich-content-container {
            margin-top: 10px;
        }

        .rich-info {
            background-color: #f5f5f5;
            border-left: 3px solid #5e35b1;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .rich-info h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .rich-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .rich-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .rich-button {
            background-color: #5e35b1;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 13px;
            cursor: pointer;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .rich-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .rich-chip {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 13px;
            color: #333;
        }

        .rich-image {
            margin-bottom: 8px;
            text-align: center;
        }

        .rich-image img {
            max-width: 100%;
            border-radius: 8px;
            max-height: 200px;
        }

        .property-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .property-image {
            height: 120px;
            position: relative;
            overflow: hidden;
        }

        .property-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .property-info {
            padding: 10px;
        }

        .property-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .property-location {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .property-price {
            font-size: 16px;
            font-weight: bold;
            color: #5e35b1;
        }
        /* Conversation Tabs - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 2 */
.conversation-tabs {
    display: flex;
    background-color: white; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
    border-bottom: 1px solid #e0e0e0;
}

.tab {
    flex: 1;
    text-align: center;
    padding: 14px 20px;
    color: var(--text-dark); /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° */
    text-decoration: none;
    position: relative;
    font-weight: 500;
    transition: all 0.3s;
}

.tab.active {
    color: white;
    background-color: #5e35b1; /* ‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
}

.count {
    display: block; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
    font-size: 12px;
    margin-top: 2px;
}

        /* Chat Panel - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á */
            .chat-panel {
                position: fixed;
                bottom: 20px; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å top: 0 ‡πÄ‡∏õ‡πá‡∏ô bottom: 20px */
                right: 20px;
                width: 500px;
                height: 700px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
                background-color: white;
                box-shadow: 0 5px 15px var(--chat-shadow);
                border-radius: 10px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö */
                display: none;
                flex-direction: column;
                z-index: 1000;
                overflow: hidden;
            }




        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }

        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏ä‡∏ó */
        .chat-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #5e35b1; /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
            color: white;
        }

        .customer-info {
            display: flex;
            flex-direction: column; /* ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
        }

        .customer-info h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .customer-info p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .search-filter {
                flex-direction: column;
            }

            .search-bar {
                width: 100%;
                margin-bottom: 10px;
            }

            .filter-btn {
                width: 100%;
                justify-content: center;
            }

            .chat-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="admin-container">
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="admin-header" style="padding: 10px 20px; background-color: #5e35b1; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 20px;">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏ä‡∏ó</h1>
            <div class="header-actions">
                <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO -->
                <div id="socket-status" class="socket-status">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                </div>
            </div>
        </header>
        <!-- Conversation Tabs -->
        <div class="conversation-tabs">
            <a href="#" class="tab active" data-status="all">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢
                <span class="count all-count">(39)</span>
            </a>
            <a href="#" class="tab" data-status="waiting">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
                <span class="count waiting-count">(30)</span>
            </a>
            <a href="#" class="tab" data-status="answered">
                ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                <span class="count answered-count">(9)</span>
            </a>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
            </div>
            <button class="filter-btn" id="filter-btn">
                <i class="fas fa-filter"></i>
                ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
            </button>
        </div>

        <!-- Conversation Table -->
        <div class="conversation-table">
            <table>
                <thead>
                <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                    <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                    <th>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                </tr>
                </thead>
                <tbody id="conversation-list">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="customer-info">
                <div id="chat-customer-name">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                <div id="chat-customer-contact">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</div>
            </div>
            <div class="chat-actions">
                <button id="admin-status-btn" class="admin-status-btn">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
                <button class="close-chat-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="chat-messages" id="adminChatMessages">
            <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á -->
            <div class="message bot">
                <div class="message-content">
                    üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á My Property ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ã‡∏∑‡πâ‡∏≠ ‡∏Ç‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πà‡∏≤‡∏≠‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏Ø ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô ‡∏ñ‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!
                </div>
            </div>

            <div class="message user">
                <div class="message-content">
                    Can I get a mortgage in Thailand?
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <input type="text" id="admin-chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
            <button class="send-btn" id="admin-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
</div>

<!-- JavaScript -->
<script src="/socket.io/socket.io.js"></script>
<script>
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    const adminState = {
        currentSessionId: null,
        isOpen: false,
        conversations: {},
        socket: null,
        adminInfo: {
            id: 'admin1',
            name: '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'
        },
        adminActive: false,
        currentWebId: '001', // Web ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö API
        apiBaseUrl: 'https://ownwebdev1.livinginsider.com/api/v1', // ‡πÄ‡∏û‡∏¥‡πà‡∏° Base URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API
        apiToken: 'b059a15197926350fb43271477779d0fc04f6a4701eb3367c999c59eeae1f890', // ‡πÄ‡∏û‡∏¥‡πà‡∏° Bearer Token
        cachedData : {}

    };

    // DOM Elements
    const elements = {
        tabButtons: document.querySelectorAll('.tab'),
        conversationList: document.getElementById('conversation-list'),
        searchInput: document.getElementById('search-input'),
        filterBtn: document.getElementById('filter-btn'),

        chatPanel: document.getElementById('chatPanel'),
        closeChatBtn: document.querySelector('.close-chat-btn'),
        chatCustomerName: document.getElementById('chat-customer-name'),
        chatCustomerContact: document.getElementById('chat-customer-contact'),

        adminSendBtn: document.getElementById('admin-send-btn'),
        adminChatInput: document.getElementById('admin-chat-input'),
        adminChatMessages: document.getElementById('adminChatMessages'),

        socketStatus: document.getElementById('socket-status'),
        adminStatusBtn: document.getElementById('admin-status-btn'),

        waitingCount: document.querySelector('.waiting-count'),
        answeredCount: document.querySelector('.answered-count'),
        allCount: document.querySelector('.all-count')
    };

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO
    function connectSocket() {
        try {
            const socketUrl = window.location.origin;

            adminState.socket = io(socketUrl);


            adminState.socket.on('connect', () => {
                console.log('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Socket.IO ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', adminState.socket.id);

                if (elements.socketStatus) {
                    elements.socketStatus.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                    elements.socketStatus.classList.add('connected');
                    elements.socketStatus.classList.remove('disconnected');
                }

                // ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
                adminState.socket.emit('join_all_rooms');

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                console.log('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á');
            });

            // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
            adminState.socket.on('new_message', (data) => {
                console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà:', data);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!data.room || !data.sender) {
                    console.error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô:', data);
                    return;
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                updateConversationInList(data);

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                if (data.room === adminState.currentSessionId) {
                    addMessageToChat(data);
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    if (data.sender === 'user') {
                        showNotification(`‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ${data.room}`);
                    }
                }
            });


            adminState.socket.on('joined_all_rooms', (data) => {
                console.log('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß:', data);
            });

            // ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            adminState.socket.on('user_request_agent', (data) => {
                console.log('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:', data);

                showNotification(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${data.userInfo?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'} ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô`);

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                loadConversations();
            });

            // ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            adminState.socket.on('admin_status_change', (data) => {
                console.log('‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:', data);

                if (data.room === adminState.currentSessionId) {
                    adminState.adminActive = data.adminActive;
                    updateAdminStatusBtn();
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            adminState.socket.on('disconnect', () => {
                console.log('‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å Socket.IO');

                if (elements.socketStatus) {
                    elements.socketStatus.textContent = '‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    elements.socketStatus.classList.add('disconnected');
                    elements.socketStatus.classList.remove('connected');
                }
            });

            return true;
        } catch (error) {
            console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO:', error);
            return false;
        }
    }

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadConversations ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö Promise
function loadConversations() {
    console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...');

    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Promise ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    return new Promise((resolve, reject) => {
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏ß‡πâ
        const currentSession = adminState.currentSessionId;
        const oldConversations = {...adminState.conversations}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ

        const apiUrl = `${adminState.apiBaseUrl}/chat/lists?web_id=${adminState.currentWebId}`;

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${adminState.apiToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å API:', data);

            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏ó‡∏µ‡πà data.data ‡πÅ‡∏ó‡∏ô data.rooms
            if (data.status === "success" && Array.isArray(data.data) && data.data.length > 0) {
                console.log('‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data.data.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                const currentConversation = currentSession ? adminState.conversations[currentSession] : null;

                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                if (!currentSession) {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    adminState.conversations = {};
                }

                data.data.sort((a, b) => {
                        const timeA = a.updatetime || (a.message && a.message.create_date) || 0;
                        const timeB = b.updatetime || (b.message && b.message.create_date) || 0;
                        return timeA - timeB; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö socket)
                });

                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
                data.data.forEach(room => {
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                        const roomId = room.ref_room_id || room.room_id;

                        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
                        if (roomId === currentSession) {
                            return;
                        }

                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
                        const message = room.message || {};
                        const lastMessage = Array.isArray(message) && message.length > 0
                            ? message[0]
                            : (typeof message === 'object' ? message : null);

                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
                        const existingConv = adminState.conversations[roomId];
                        if (existingConv && lastMessage) {
                            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
                            const existingTime = existingConv.lastActivity || 0;
                            const newTime = lastMessage.create_date || lastMessage.timestamp || room.updatetime || 0;
                            if (existingTime > newTime) {
                                return;
                            }
                        }

                    adminState.conversations[roomId] = {
                        sessionId: roomId,
                        roomId: roomId,
                        webId: adminState.currentWebId,
                        userInfo: room.contact_info || {},
                        status: room.status_reply ? 'answered' : 'waiting',
                        lastActivity: room.updatetime || Date.now(),
                        lastMessage: lastMessage ? {
                            text: lastMessage.message || lastMessage.detail || '',
                            sender: lastMessage.sender || 'user',
                            timestamp: lastMessage.create_date || lastMessage.timestamp || Date.now()
                        } : null
                    };
                });

                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (currentConversation && currentSession) {
                    adminState.conversations[currentSession] = currentConversation;
                    console.log('‡∏Ñ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ:', currentSession);
                }

                updateConversationCounts(Object.values(adminState.conversations));
                renderConversationList();

                resolve(adminState.conversations);

            } else {
                console.error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:', data);

                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                adminState.conversations = oldConversations;

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                updateConversationCounts(Object.values(adminState.conversations));

                // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πá‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏à‡∏∂‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (Object.keys(adminState.conversations).length === 0) {
                    elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</td></tr>';
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                    renderConversationList();
                }

                // ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ
                resolve(adminState.conversations);
            }

            if (data.status === "success" && Array.isArray(data.data) && data.data.length > 0) {
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡∏ä
                adminState.cachedData = {...data};
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (adminState.cachedData.status === "success" &&
                    Array.isArray(adminState.cachedData.data) &&
                    adminState.cachedData.data.length > 0) {

                    console.log('‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä');
                    data = {...adminState.cachedData};
                }
            }
        })
        .catch(error => {
            console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:', error);

            // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
            adminState.conversations = oldConversations;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (Object.keys(adminState.conversations).length === 0) {
                elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message + '</td></tr>';
            } else {
                // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                renderConversationList();

                // ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó: ' + error.message, 'error');
            }

            // ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ
            reject(error);
        });
    });
}

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ó‡πá‡∏ö
    function updateConversationCounts(conversations) {
        const waitingCount = conversations.filter(conv => conv.status === 'waiting').length;
        const answeredCount = conversations.filter(conv => conv.status === 'answered').length;
        const totalCount = conversations.length;

        if (elements.waitingCount) elements.waitingCount.textContent = `(${waitingCount})`;
        if (elements.answeredCount) elements.answeredCount.textContent = `(${answeredCount})`;
if (elements.allCount) elements.allCount.textContent = `(${totalCount})`;
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
function renderConversationList() {
    // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
    const activeTab = document.querySelector('.tab.active');
    const currentStatus = activeTab ? activeTab.dataset.status : 'all';

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    const searchText = elements.searchInput.value.trim().toLowerCase();

    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    let filteredConversations = Object.values(adminState.conversations);

    if (currentStatus !== 'all') {
        filteredConversations = filteredConversations.filter(conv => conv.status === currentStatus);
    }

    if (searchText) {
        filteredConversations = filteredConversations.filter(conv => {
            const userInfo = conv.userInfo || {};
            const name = (userInfo.name || '').toLowerCase();
            const email = (userInfo.email || '').toLowerCase();
            const phone = (userInfo.phone || '').toLowerCase();
            const lastMessage = conv.lastMessage && conv.lastMessage.text ? conv.lastMessage.text.toLowerCase() : '';

            return name.includes(searchText) ||
                   email.includes(searchText) ||
                   phone.includes(searchText) ||
                   lastMessage.includes(searchText);
        });
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    filteredConversations.sort((a, b) => {
    // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á (lastActivity ‡∏´‡∏£‡∏∑‡∏≠ timestamp ‡∏Ç‡∏≠‡∏á lastMessage)
    const timeA = a.lastActivity || (a.lastMessage && a.lastMessage.timestamp) || 0;
    const timeB = b.lastActivity || (b.lastMessage && b.lastMessage.timestamp) || 0;
    return timeB - timeA; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
});
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML
    if (filteredConversations.length === 0) {
        elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
        return;
    }

    let html = '';

    filteredConversations.forEach(conv => {
        const userInfo = conv.userInfo || {};
        const name = userInfo.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
        const email = userInfo.email || '-';
        const phone = userInfo.phone || '-';

        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
        const lastActivityDate = new Date(conv.lastActivity);
        const formattedDate = `${lastActivityDate.toLocaleDateString('th-TH')}<br>${lastActivityDate.toLocaleTimeString('th-TH')}`;

        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        let lastMessageText = '-';
        if (conv.lastMessage && conv.lastMessage.text) {
            lastMessageText = `"${conv.lastMessage.text.substring(0, 30)}${conv.lastMessage.text.length > 30 ? '...' : ''}"`;
        }

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusClass = conv.status === 'waiting' ? 'pending' : 'completed';
        const statusText = conv.status === 'waiting' ? '‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö' : '‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß';

        html += `
            <tr>
                <td>${escapeHTML(name)}</td>
                <td>${formattedDate}</td>
                <td>${escapeHTML(lastMessageText)}</td>
                <td>${escapeHTML(phone)}<br>${escapeHTML(email)}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td><button class="action-btn chat-btn" data-id="${conv.sessionId}">‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢</button></td>
            </tr>
        `;
    });

    elements.conversationList.innerHTML = html;

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó
    document.querySelectorAll('.chat-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.dataset.id;
            openChatSession(sessionId);
        });
    });
}

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
function openChatSession(sessionId) {
  console.log('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó:', sessionId);

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏à‡∏≤‡∏Å state
  const conversation = adminState.conversations[sessionId];

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å sessionId ‡πÅ‡∏•‡∏∞ roomId ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  adminState.currentSessionId = sessionId;
  adminState.currentRoomId = conversation ? (conversation.roomId || sessionId) : sessionId;

  // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó
  elements.chatPanel.style.display = 'flex';
  elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</div>';

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
  const webId = adminState.currentWebId;
  const roomId = adminState.currentRoomId;
  const apiUrl = `${adminState.apiBaseUrl}/chat/open?web_id=${webId}&room_id=${roomId}`;

  console.log('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:', apiUrl);

  fetch(apiUrl, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${adminState.apiToken}`
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API:', data);

    if (data.status === "success") {
      console.log('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      const userInfo = data.contact_info || {};
      const name = userInfo.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
      const email = userInfo.email || '';
      const phone = userInfo.phone || '';
      const contact = [email, phone].filter(Boolean).join(' ‚Ä¢ ') || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠';

      elements.chatCustomerName.textContent = name;
      elements.chatCustomerContact.textContent = contact;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      adminState.adminActive = data.status_reply === 1;
      updateAdminStatusBtn();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
      if (data.messages && data.messages.length > 0) {
        displayChatHistory(data.messages);
      } else {
        elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ô‡∏µ‡πâ</div>';
      }
    } else {
      elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:red;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</div>';
    }
  })
  .catch(error => {
    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:', error);
    elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  });

  // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó (‡πÉ‡∏ä‡πâ Socket.IO)
  if (adminState.socket) {
    console.log('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á:', sessionId);
    adminState.socket.emit('join', sessionId);
  }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
function displayChatHistory(messages) {
    if (!messages || messages.length === 0) {
        elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ô‡∏µ‡πâ</div>';
        return;
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
    elements.adminChatMessages.innerHTML = '';

    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å messages ‡∏à‡∏≤‡∏Å API ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    const sortedMessages = [...messages].sort((a, b) => {
        return a.create_date - b.create_date;
    });

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà
    sortedMessages.forEach(msg => {
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addMessageToChat
        const messageData = {
            sender: msg.sender,
            text: msg.message || '', // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á message ‡πÅ‡∏•‡∏∞ text
            timestamp: msg.create_date,
            adminName: msg.adminName || (msg.sender === 'admin' ? adminState.adminInfo.name : undefined),
            room: adminState.currentSessionId
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô item_list ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏£‡∏¥‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå)
        if (msg.type === 3 && msg.item_list && Array.isArray(msg.item_list)) {
            messageData.payload = {
                richContent: [
                    [
                        {
                            type: "info",
                            title: msg.message || "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏£‡∏¥‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå",
                            subtitle: `‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${msg.item_list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                        },
                        ...msg.item_list.map(item => ({
                            type: "custom_card",
                            property_data: {
                                id: item.web_id,
                                imageUrl: item.photo || '',
                                title: item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
                                location: item.zone_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á',
                                price: item.price || '-',
                                tag: item.tag || '‡∏Ç‡∏≤‡∏¢',
                                link: item.link || '#'
                            }
                        }))
                    ]
                ]
            };

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (msg.more && msg.more.link) {
                messageData.payload.richContent[0].push({
                    type: "button",
                    options: [
                        {
                            text: msg.more.txt || "‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
                            link: msg.more.link
                        }
                    ]
                });
            }
        } else if (msg.type === 2 && msg.options && Array.isArray(msg.options)) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô chips
            messageData.payload = {
                richContent: [
                    [
                        {
                            type: "chips",
                            options: msg.options.map(option => ({ text: option }))
                        }
                    ]
                ]
            };
        }

        addMessageToChat(messageData);
    });

    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    scrollToBottom();
}

function addMessageToChat(data) {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (isMessageDuplicate(data.timestamp)) {
        console.log('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥ ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ã‡πâ‡∏≥');
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const messageDiv = document.createElement('div');

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î class ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á
    if (data.sender === 'user') {
        messageDiv.className = 'message user'; // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤
    } else if (data.sender === 'bot') {
        messageDiv.className = 'message bot'; // ‡∏ö‡∏≠‡∏ó‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢
    } else if (data.sender === 'admin') {
        messageDiv.className = 'message admin'; // ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢
    } else if (data.sender === 'system') {
        messageDiv.className = 'message system'; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ attribute ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥
    messageDiv.setAttribute('data-message-id', data.timestamp);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á
    let messageHTML = '';

    if (data.sender === 'user') {
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
            </div>
        `;
    } else if (data.sender === 'bot') {
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó
        let richContentHtml = '';
        if (data.payload) {
            richContentHtml = renderRichContent(data.payload);
        }

        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
                ${richContentHtml}
                <small>‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢ : ‡∏ö‡∏≠‡∏ó</small>

            </div>
        `;
    } else if (data.sender === 'admin') {
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
                <small>‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢ : ${escapeHTML(data.adminName || adminState.adminInfo.name)}</small>
            </div>
        `;
    } else if (data.sender === 'system') {
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
            </div>
        `;
    }

    // ‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    messageDiv.innerHTML = messageHTML;

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó
    elements.adminChatMessages.appendChild(messageDiv);

    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    scrollToBottom();
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥
function isMessageDuplicate(messageId) {
    return document.querySelector(`.message[data-message-id="${messageId}"]`) !== null;
}

// ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
function scrollToBottom() {
    elements.adminChatMessages.scrollTop = elements.adminChatMessages.scrollHeight;
}

// ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó
function closeChatPanel() {
    // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
    if (adminState.currentSessionId && adminState.socket) {
        adminState.socket.emit('leave', adminState.currentSessionId);
        console.log('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á:', adminState.currentSessionId);
    }

    adminState.currentSessionId = null;
    elements.chatPanel.style.display = 'none';
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
function sendAdminMessage() {
  const message = elements.adminChatInput.value.trim();
  if (!message || !adminState.currentSessionId) return;

  const timestamp = Date.now();
  const roomId = adminState.currentRoomId || adminState.currentSessionId;
  const webId = adminState.currentWebId;

  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó
  addMessageToChat({
    sender: 'admin',
    text: message,
    adminName: adminState.adminInfo.name,
    timestamp: timestamp,
    room: adminState.currentSessionId
  });

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á API
  const formData = new FormData();
  formData.append('room_id', roomId);
  formData.append('web_id', webId);
  formData.append('detail', message);
  formData.append('type', '1'); // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
  formData.append('sender', 'admin');
  formData.append('options', ''); // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô API
  fetch(`${adminState.apiBaseUrl}/chat/send/sms`, {
    method: 'POST',
        headers: {
            'Authorization': `Bearer ${adminState.apiToken}` // ‡πÄ‡∏û‡∏¥‡πà‡∏° Bearer Token ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô headers
        },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    console.log('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ conversation ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô 'answered'
    if (adminState.conversations[adminState.currentSessionId]) {
      adminState.conversations[adminState.currentSessionId].status = 'answered';
      renderConversationList();
    }
  })
  .catch(error => {
    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô API:', error);
    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'error');
  });

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô Socket.IO ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
  if (adminState.socket) {
    adminState.socket.emit('new_message', {
      sender: 'admin',
      text: message,
      adminId: adminState.adminInfo.id,
      adminName: adminState.adminInfo.name,
      timestamp: timestamp,
      room: adminState.currentSessionId
    });
  }

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  elements.adminChatInput.value = '';
  elements.adminChatInput.focus();
}

// ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
function toggleAdminStatus() {
    if (!adminState.currentSessionId) return;

    adminState.adminActive = !adminState.adminActive;
    updateAdminStatusBtn();

    // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏õ‡∏¢‡∏±‡∏á Socket.IO
    if (adminState.socket) {
        adminState.socket.emit('admin_status_change', {
            type: 'admin_status_change',
            adminActive: adminState.adminActive,
            timestamp: Date.now(),
            room: adminState.currentSessionId,
            adminId: adminState.adminInfo.id,
            adminName: adminState.adminInfo.name
        });
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    showNotification(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${adminState.adminActive ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}`);
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
function updateAdminStatusBtn() {
    if (adminState.adminActive) {
        elements.adminStatusBtn.textContent = '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
        elements.adminStatusBtn.classList.add('active');
    } else {
        elements.adminStatusBtn.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';
        elements.adminStatusBtn.classList.remove('active');
    }
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
function updateConversationInList(data) {
    if (!data || !data.room) return;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà
    if (!adminState.conversations[data.room]) {
        adminState.conversations[data.room] = {
            sessionId: data.room,
            userInfo: { name: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠' },
            status: data.sender === 'user' ? 'waiting' : 'answered',
            lastActivity: data.timestamp || Date.now(),
            lastMessage: {
                text: data.text,
                sender: data.sender,
                timestamp: data.timestamp || Date.now()
            }
        };
    } else {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        adminState.conversations[data.room].lastActivity = data.timestamp || Date.now();
        adminState.conversations[data.room].lastMessage = {
            text: data.text,
            sender: data.sender,
            timestamp: data.timestamp || Date.now()
        };

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (data.sender === 'user') {
            adminState.conversations[data.room].status = 'waiting';
        } else if (data.sender === 'admin') {
            adminState.conversations[data.room].status = 'answered';
        }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    updateConversationCounts(Object.values(adminState.conversations));
    renderConversationList();
}

// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á Rich Content
function renderRichContent(payload) {
    if (!payload || !payload.richContent || !payload.richContent.length) {
        return '';
    }

    let html = '<div class="rich-content-container">';

    payload.richContent[0].forEach(item => {
        if (item.type === 'info') {
            html += `
                <div class="rich-info">
                    <h4>${escapeHTML(item.title || '')}</h4>
                    <p>${escapeHTML(item.subtitle || '')}</p>
                </div>
            `;
        } else if (item.type === 'button') {
            html += '<div class="rich-buttons">';
            if (item.options && Array.isArray(item.options)) {
                item.options.forEach(btn => {
                    html += `<button class="rich-button">${escapeHTML(btn.text || 'Button')}</button>`;
                });
            } else if (item.text) {
                html += `<button class="rich-button">${escapeHTML(item.text)}</button>`;
            }
            html += '</div>';
        } else if (item.type === 'chips') {
            html += '<div class="rich-chips">';
            if (item.options && Array.isArray(item.options)) {
                item.options.forEach(chip => {
                    html += `<span class="rich-chip">${escapeHTML(chip.text || '')}</span>`;
                });
            }
            html += '</div>';
        } else if (item.type === 'image') {
            const imgSrc = item.rawUrl || (item.image && item.image.src ? item.image.src.rawUrl : '');
            if (imgSrc) {
                html += `<div class="rich-image"><img src="${escapeHTML(imgSrc)}" alt="Image"></div>`;
            }
        } else if (item.type === 'custom_card' && item.property_data) {
            const propData = item.property_data;
            html += `
                <div class="property-card">
                    <div class="property-image">
                        <img src="${escapeHTML(propData.imageUrl || '')}" alt="Property">
                        <div class="property-tag">${escapeHTML(propData.tag || '‡∏Ç‡∏≤‡∏¢')}</div>
                    </div>
                    <div class="property-info">
                        <div class="property-title">${escapeHTML(propData.title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠')}</div>
                        <div class="property-location">${escapeHTML(propData.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á')}</div>
                        <div class="property-price">‡∏ø${escapeHTML(propData.price || '-')}</div>
                    </div>
                </div>
            `;
        }
    });

    html += '</div>';
    return html;
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `admin-notification ${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}

// ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS
function escapeHTML(text) {
    if (!text) return '';
    return text
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
function init() {


    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO
    connectSocket();

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners

    // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ó‡πá‡∏ö
    elements.tabButtons.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();

            // ‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ active ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏ó‡πá‡∏ö
            elements.tabButtons.forEach(t => t.classList.remove('active'));

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ active ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
            this.classList.add('active');

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ï‡∏≤‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            renderConversationList();
        });
    });

    // ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    elements.searchInput.addEventListener('input', function() {
        renderConversationList();
    });

    // ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    elements.adminSendBtn.addEventListener('click', sendAdminMessage);

    // ‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    elements.adminChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendAdminMessage();
        }
    });

    // ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó
    elements.closeChatBtn.addEventListener('click', closeChatPanel);

    // ‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    elements.adminStatusBtn.addEventListener('click', toggleAdminStatus);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadConversations();

    adminState.isLoading = false;
adminState.lastLoadTime = 0;

setInterval(() => {
    // ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    const now = Date.now();
    if (now - adminState.lastLoadTime < 3000) {
        console.log('‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô ‡∏£‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
        return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (adminState.isLoading) {
        console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ');
        return;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (adminState.currentSessionId) {
        console.log('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏≠‡∏¢‡∏π‡πà ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà');
        // ‡∏≠‡∏≤‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    } else {
        console.log('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà');

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
        adminState.isLoading = true;

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
        loadConversations()
            .then(() => {
                adminState.lastLoadTime = Date.now();
            })
            .finally(() => {
                adminState.isLoading = false;
            });
    }
}, 5000);

    }

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
