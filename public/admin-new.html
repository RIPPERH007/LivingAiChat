<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Live Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6F6158;
            --secondary: #2bbd7e;
            --purple: #5e35b1;
            --text-dark: #333;
            --text-light: #777;
            --bg-light: #f5f5f5;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --pending: #ff3b30;
            --completed: #34c759;
            --waiting: #ffc107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            background-color: #f8f9fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 0;
        }

        /* Conversation Tabs */
        .conversation-tabs {
            display: flex;
            background-color: var(--purple);
            color: white;
            margin-bottom: 0;
            border-bottom: none;
        }

        .tab {
            padding: 15px 25px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            position: relative;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .count {
            display: inline-block;
            background-color: white;
            color: var(--purple);
            border-radius: 12px;
            padding: 0 8px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0;
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .search-bar {
            width: 60%;
            display: flex;
            align-items: center;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 0 15px;
            box-shadow: none;
        }

        .search-bar i {
            color: var(--text-light);
            margin-right: 10px;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 0;
            border: none;
            outline: none;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            color: var(--text-dark);
        }

        .filter-btn:hover {
            background-color: var(--bg-light);
        }

        .filter-btn i {
            margin-right: 8px;
            color: var(--text-dark);
        }

        /* Conversation Table */
        .conversation-table {
            background-color: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            margin-bottom: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 500;
            color: var(--text-dark);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 14px;
        }

        tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* สถานะ */
        .status {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.pending {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--pending);
        }

        .status.pending::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--pending);
            border-radius: 50%;
            margin-right: 5px;
        }

        .status.completed {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--completed);
        }

        .status.completed::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--completed);
            border-radius: 50%;
            margin-right: 5px;
        }

        /* ปุ่ม */
        .action-btn {
            padding: 8px 16px;
            background-color: white;
            color: var(--purple);
            border: 1px solid var(--purple);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .action-btn:hover {
            background-color: var(--purple);
            color: white;
        }




        .chat-actions button {
            background: none;
            border: none;
            font-size: 16px;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }

        .admin-status-btn {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-status-btn.active {
            background-color: rgba(255, 255, 255, 0.3);
        }



        /* แก้ไข CSS โดยสลับฝั่ง user กับ admin/bot */
        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 85%;
            width: 100%;
            clear: both;
        }

        /* ข้อความของผู้ใช้ (user) แสดงที่ฝั่งซ้าย */
        .message.user {
            float: left;
            margin-right: auto;
            margin-left: 0;
            flex-direction: row; /* ทิศทางปกติ */
        }

        /* ข้อความของบอทและแอดมินแสดงที่ฝั่งขวา */
        .message.bot, .message.admin {
            float: right;
            margin-left: auto;
            margin-right: 0;
            flex-direction: row-reverse; /* กลับทิศทาง */
        }

        /* สไตล์ข้อความ */
        .message-content {
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            max-width: 80%;
        }

        /* สไตล์ข้อความผู้ใช้ (อยู่ซ้าย) */
        .message.user .message-content {
            background-color: #f5f5f5;
            color: #333;
            border-top-left-radius: 4px;
            margin-right: auto; /* ย้ายไปทางซ้าย */
        }

        /* สไตล์ข้อความแอดมิน (อยู่ขวา) */
        .message.admin .message-content {
            background-color: #8e44ad; /* สีม่วง */
            color: white;
            border-top-right-radius: 4px;
            margin-left: auto; /* ย้ายไปทางขวา */
        }

        /* สไตล์ข้อความบอท (อยู่ขวา) */
        .message.bot .message-content {
             background-color: #f5f5f5;
            border-top-right-radius: 4px;
            margin-left: auto; /* ย้ายไปทางขวา */
        }

        /* ข้อความระบบ (อยู่ตรงกลาง) */
        .message.system {
            width: 100%;
            display: flex;
            justify-content: center;
            max-width: 100%;
        }

        .message.system .message-content {
            background-color: #f0f0f0;
            font-size: 12px;
            text-align: center;
            color: #666;
            max-width: 70%;
        }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            background-color: var(--purple);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
        }

        /* Socket Status */
        .socket-status {
            display: inline-block;
            margin-right: 15px;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .socket-status.connected {
            background-color: rgba(43, 189, 126, 0.2);
            color: #2bbd7e;
        }

        .socket-status.disconnected {
            background-color: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        /* การแจ้งเตือน */
        .admin-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(43, 189, 126, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .admin-notification.fade-out {
            animation: fadeOut 0.5s ease forwards;
        }

        .admin-notification.error {
            background-color: rgba(255, 59, 48, 0.9);
        }

        /* Rich Content Styles */
        .rich-content-container {
            margin-top: 10px;
        }

        .rich-info {
            background-color: #f5f5f5;
            border-left: 3px solid #5e35b1;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .rich-info h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .rich-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .rich-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .rich-button {
            background-color: #5e35b1;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 13px;
            cursor: pointer;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
        }

        .rich-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .rich-chip {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 13px;
            color: #333;
        }

        .rich-image {
            margin-bottom: 8px;
            text-align: center;
        }

        .rich-image img {
            max-width: 100%;
            border-radius: 8px;
            max-height: 200px;
        }

        .property-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .property-image {
            height: 120px;
            position: relative;
            overflow: hidden;
        }

        .property-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .property-info {
            padding: 10px;
        }

        .property-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .property-location {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .property-price {
            font-size: 16px;
            font-weight: bold;
            color: #5e35b1;
        }
        /* Conversation Tabs - แก้ไขตามรูปที่ 2 */
.conversation-tabs {
    display: flex;
    background-color: white; /* เปลี่ยนจากสีม่วงเป็นสีขาว */
    border-bottom: 1px solid #e0e0e0;
}

.tab {
    flex: 1;
    text-align: center;
    padding: 14px 20px;
    color: var(--text-dark); /* เปลี่ยนสีตัวอักษรเป็นสีเข้ม */
    text-decoration: none;
    position: relative;
    font-weight: 500;
    transition: all 0.3s;
}

.tab.active {
    color: white;
    background-color: #5e35b1; /* แท็บที่เลือกมีพื้นหลังสีม่วงเข้ม */
}

.count {
    display: block; /* เปลี่ยนเป็น block เพื่อให้ตัวเลขอยู่ด้านล่าง */
    font-size: 12px;
    margin-top: 2px;
}

        /* Chat Panel - แก้ไขตามคำขอให้เป็นแบบขวาล่าง */
            .chat-panel {
                position: fixed;
                bottom: 20px; /* เปลี่ยนจาก top: 0 เป็น bottom: 20px */
                right: 20px;
                width: 500px;
                height: 700px; /* ปรับความสูงให้พอดี */
                background-color: white;
                box-shadow: 0 5px 15px var(--chat-shadow);
                border-radius: 10px; /* เพิ่มความโค้งของขอบ */
                display: none;
                flex-direction: column;
                z-index: 1000;
                overflow: hidden;
            }




        /* ปรับพื้นที่แสดงข้อความ */
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }

        /* แก้ไขสีของส่วนหัวแชท */
        .chat-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #5e35b1; /* ใช้สีม่วงเข้ม */
            color: white;
        }

        .customer-info {
            display: flex;
            flex-direction: column; /* แสดงข้อมูลในแนวตั้ง */
        }

        .customer-info h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .customer-info p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15px 0;
        background-color: white;
        border-top: 1px solid var(--border);
        gap: 5px;
    }

    .pagination-btn {
        width: 36px;
        height: 36px;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid var(--border);
        background-color: white;
        color: var(--text-dark);
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-btn:hover:not([disabled]) {
        background-color: var(--bg-light);
    }

    .pagination-btn.active {
        background-color: var(--purple);
        color: white;
        border-color: var(--purple);
    }

    .pagination-btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-ellipsis {
        width: 36px;
        height: 36px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        color: var(--text-light);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .pagination-container {
            flex-wrap: wrap;
        }

        .pagination-btn {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
    }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .search-filter {
                flex-direction: column;
            }

            .search-bar {
                width: 100%;
                margin-bottom: 10px;
            }

            .filter-btn {
                width: 100%;
                justify-content: center;
            }

            .chat-panel {
                width: 100%;
            }
        }
    </style>
    <style>
        /* Sortable Table Header Styles */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
        }

        .sortable:hover {
            background-color: #f5f5f5;
        }

        .sort-icon {
            margin-left: 8px;
            font-size: 12px;
            color: #999;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .sortable:hover .sort-icon {
            opacity: 1;
            color: #666;
        }

        .sortable.sort-asc .sort-icon::before {
            content: "\f0de"; /* fa-sort-up */
            color: #5e35b1;
            opacity: 1;
        }

        .sortable.sort-desc .sort-icon::before {
            content: "\f0dd"; /* fa-sort-down */
            color: #5e35b1;
            opacity: 1;
        }

        .sortable.sort-asc,
        .sortable.sort-desc {
            background-color: rgba(94, 53, 177, 0.1);
        }

        .sortable.sort-asc .sort-icon,
        .sortable.sort-desc .sort-icon {
            color: #5e35b1;
            opacity: 1;
        }

        /* เพิ่มสีเมื่อ hover บนหัวข้อที่สามารถเรียงได้ */
        .sortable::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #5e35b1;
            transition: width 0.3s;
        }

        .sortable:hover::after {
            width: 100%;
        }

        .sortable.sort-asc::after,
        .sortable.sort-desc::after {
            width: 100%;
        }
    </style>
    <style>
        /* Header - เพิ่มปุ่ม Settings */
        .header-left h1 {
            font-size: 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Settings Dialog Overlay */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .settings-overlay.show {
            display: flex;
        }

        /* Settings Dialog */
        .settings-dialog {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Dialog Header */
        .dialog-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--purple);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .dialog-title {
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dialog-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .dialog-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Dialog Content */
        .dialog-content {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            transition: border-color 0.3s;
            background-color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 0 3px rgba(94, 53, 177, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Profile Image Upload */
        .profile-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .profile-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-light);
            overflow: hidden;
            position: relative;
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-preview .placeholder {
            color: var(--text-light);
            font-size: 24px;
        }

        .upload-btn {
            background-color: var(--purple);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background-color: #4a2c94;
        }

        .file-input {
            display: none;
        }

        /* Dialog Footer */
        .dialog-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: #fafafa;
            border-radius: 0 0 12px 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Prompt', 'Sarabun', 'Kanit', sans-serif;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background-color: white;
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--bg-light);
        }

        .btn-primary {
            background-color: var(--purple);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4a2c94;
        }

        /* Success/Error Messages */
        .message-dialog {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .message-dialog.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-dialog.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-dialog.show {
            display: flex;
        }

        /* Mobile Responsive สำหรับ Settings */
        @media (max-width: 768px) {
            .settings-dialog {
                width: 95%;
                margin: 10px;
            }

            .dialog-content {
                padding: 16px;
            }
        }
    </style>

</head>
<body>
<script src="env-config.js"></script>


<div class="admin-container">
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="admin-header" style="padding: 10px 20px; background-color: #5e35b1; color: white; display: flex; justify-content: space-between; align-items: center;">
            <div class="header-left">
                <h1>แอดมินแชท</h1>
            </div>
            <div class="header-right">
                <div id="socket-status" class="socket-status">
                    กำลังเชื่อมต่อ...
                </div>
                <button class="settings-btn" id="settingsBtn" title="ตั้งค่า">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>
        <!-- Conversation Tabs -->
        <div class="conversation-tabs">
            <a href="#" class="tab active" data-status="all">
                กำลังคุย
                <span class="count all-count">(39)</span>
            </a>
            <a href="#" class="tab" data-status="waiting">
                ยังไม่ได้ตอบกลับ
                <span class="count waiting-count">(30)</span>
            </a>
            <a href="#" class="tab" data-status="answered">
                ตอบกลับแล้ว
                <span class="count answered-count">(9)</span>
            </a>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="ค้นหาตามชื่อ หรือเบอร์โทร">
            </div>
        </div>

        <!-- Conversation Table -->
        <div class="conversation-table">
            <table>
                <thead>
                <tr>
                    <th class="sortable" data-sort="name">
                        ชื่อ
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="lastActivity">
                        เวลาติดต่อ
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="lastMessage">
                        ข้อความล่าสุด
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="contact">
                        ติดต่อ
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="status">
                        สถานะ
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th>การดำเนินการ</th>
                </tr>
                </thead>
                <tbody id="conversation-list">
                <!-- รายการการสนทนาจะแสดงที่นี่ -->
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูลการสนทนา...</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-container" id="pagination-container">
            <!-- ปุ่มแบ่งหน้าจะถูกเพิ่มโดย JavaScript -->
        </div>

    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="customer-info">
                <div id="chat-customer-name">ลูกค้า</div>
                <div id="chat-customer-contact">เยี่ยมชมเว็บไซต์</div>
            </div>
            <div class="chat-actions">
                <button id="admin-status-btn" class="admin-status-btn">เปิดใช้งานแอดมิน</button>
                <button class="close-chat-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="chat-messages" id="adminChatMessages">

            <div class="message user">
                <div class="message-content">
                    Can I get a mortgage in Thailand?
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <input type="text" id="admin-chat-input" placeholder="พิมพ์ข้อความ...">
            <button class="send-btn" id="admin-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>
<div class="settings-overlay" id="settingsOverlay">
    <div class="settings-dialog">
        <!-- Dialog Header -->
        <div class="dialog-header">
            <h3 class="dialog-title">
                <i class="fas fa-cog"></i>
                ตั้งค่าโปรไฟล์
            </h3>
            <button class="dialog-close" id="closeSettingsBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Dialog Content -->
        <div class="dialog-content">
            <!-- Success/Error Messages -->
            <div class="message-dialog success" id="successMessage">
                <i class="fas fa-check-circle"></i>
                <span>บันทึกการตั้งค่าเรียบร้อยแล้ว</span>
            </div>
            <div class="message-dialog error" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span>เกิดข้อผิดพลาดในการบันทึก กรุณาลองใหม่อีกครั้ง</span>
            </div>

            <form id="settingsForm">
                <!-- 1. Profile Image Upload -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-user-circle"></i>
                        รูปโปรไฟล์
                    </label>
                    <div class="profile-upload">
                        <div class="profile-preview" id="profilePreview">
                            <i class="fas fa-user placeholder"></i>
                        </div>
                        <button type="button" class="upload-btn" id="uploadBtn">
                            <i class="fas fa-upload"></i>
                            เลือกรูปภาพ
                        </button>
                        <input type="file" class="file-input" id="profileImageInput" accept="image/*">
                    </div>
                </div>

                <!-- 2. Admin Name -->
                <div class="form-group">
                    <label class="form-label" for="adminName">
                        <i class="fas fa-id-badge"></i>
                        ชื่อแอดมิน
                    </label>
                    <input
                            type="text"
                            class="form-input"
                            id="adminName"
                            placeholder="กรุณากรอกชื่อแอดมิน"
                            maxlength="50"
                            required
                    >
                </div>

                <!-- 3. Greeting Message -->
                <div class="form-group">
                    <label class="form-label" for="greetingMessage">
                        <i class="fas fa-comment-dots"></i>
                        ข้อความต้อนรับ
                    </label>
                    <textarea
                            class="form-input form-textarea"
                            id="greetingMessage"
                            placeholder="กรอกข้อความต้อนรับสำหรับลูกค้า เช่น สวัสดีครับ ยินดีให้บริการ..."
                            maxlength="2555"
                            rows="4"
                            required
                    ></textarea>
                    <small style="color: var(--text-light); font-size: 12px;">
                        ข้อความนี้จะแสดงเป็นข้อความแรกเมื่อลูกค้าเริ่มสนทนา
                    </small>
                </div>
            </form>
        </div>

        <!-- Dialog Footer -->
        <div class="dialog-footer">
            <button type="button" class="btn btn-secondary" id="cancelBtn">
                <i class="fas fa-times"></i>
                ยกเลิก
            </button>
            <button type="submit" form="settingsForm" class="btn btn-primary" id="saveBtn">
                <i class="fas fa-save"></i>
                บันทึก
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/piesocket-js@5"></script>

<script>
        console.log('Admin page - PieSocket v5:', typeof PieSocket);
        console.log('Admin page - PieSocket object:', PieSocket);
    </script>
<script>
    // สถานะของแอดมิน
    const adminState = {
        currentSessionId: null,
        isOpen: false,
        conversations: {},
        socket: null,
        adminInfo: {
            id: 'admin1',
            name: 'แอดมินโอม',
            image:'https://png.pngtree.com/png-vector/20230316/ourmid/pngtree-admin-and-customer-service-job-vacancies-vector-png-image_6650726.png'
        },
        adminActive: false,
        currentWebId: '001', // Web ID สำหรับใช้กับ API
        apiBaseUrl: window.env.BASE_API_URL, // เพิ่ม Base URL สำหรับ API
        apiToken: window.env.TOKEN_API, // เพิ่ม Bearer Token
        cachedData : {},
        pagination : {
            currentPage: 1,
            itemsPerPage: 10,
            totalPages: 1
        },


    };

    // DOM Elements
    const elements = {
        tabButtons: document.querySelectorAll('.tab'),
        conversationList: document.getElementById('conversation-list'),
        searchInput: document.getElementById('search-input'),
        filterBtn: document.getElementById('filter-btn'),

        chatPanel: document.getElementById('chatPanel'),
        closeChatBtn: document.querySelector('.close-chat-btn'),
        chatCustomerName: document.getElementById('chat-customer-name'),
        chatCustomerContact: document.getElementById('chat-customer-contact'),

        adminSendBtn: document.getElementById('admin-send-btn'),
        adminChatInput: document.getElementById('admin-chat-input'),
        adminChatMessages: document.getElementById('adminChatMessages'),

        socketStatus: document.getElementById('socket-status'),
        adminStatusBtn: document.getElementById('admin-status-btn'),

        waitingCount: document.querySelector('.waiting-count'),
        answeredCount: document.querySelector('.answered-count'),
        allCount: document.querySelector('.all-count'),
            paginationContainer: document.getElementById('pagination-container'),

    };

   function connectSocket() {
    try {
        const clusterId = 's8661.sgp1';
        const apiKey = 'mOGIGJTyKOmsesgjpchKEECKLekVGmuCSwNv2wpl';
        const jwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwdWJsaWMtY2hhbm5lbC1vd253ZWItZGV2ZWxvcG1lbnQiLCJwbGF0Zm9ybSI6Im93bndlYiIsImlhdCI6MTc0NzkwMDg0MSwiZXhwIjoyMDYzMjYwODQxfQ.-QO3q_RExUV9NjOMpPuJXqnisGaH1934nN8xvlDJgZU';

        console.log('Creating admin PieSocket v5 instance...');

        // สร้าง PieSocket v5 instance
        let pieSocketInstance;

        if (typeof PieSocket === 'function') {
            pieSocketInstance = new PieSocket({
                clusterId: clusterId,
                apiKey: apiKey,
                notifySelf: 1,
                forceAuth: true,
                jwt: jwtToken
            });
        } else if (PieSocket && typeof PieSocket.default === 'function') {
            pieSocketInstance = new PieSocket.default({
                clusterId: clusterId,
                apiKey: apiKey,
                notifySelf: 1,
                forceAuth: true,
                jwt: jwtToken
            });
        } else {
            pieSocketInstance = PieSocket({
                clusterId: clusterId,
                apiKey: apiKey,
                notifySelf: 1,
                forceAuth: true,
                jwt: jwtToken
            });
        }

        adminState.socket = pieSocketInstance;

        // กำหนด channel name
        const environment = 'development';
        const channelName = `public-channel-ownweb-${environment}`;

        adminState.socket.subscribe(channelName, {
            platform: 'ownweb'
        }).then((channel) => {
            console.log('เชื่อมต่อกับ PieSocket สำเร็จ:', channelName);
            adminState.adminChannel = channel;

            if (elements.socketStatus) {
                elements.socketStatus.textContent = 'เชื่อมต่อแล้ว';
                elements.socketStatus.classList.add('connected');
                elements.socketStatus.classList.remove('disconnected');
            }

            // รับข้อความใหม่
            channel.listen('new_message', (data) => {
                console.log('=== ADMIN RECEIVED MESSAGE ===');
                console.log('Message data:', data);
                console.log('Sender:', data.sender);
                console.log('Room:', data.room);
                console.log('SessionId:', data.sessionId);

                console.log('ได้รับข้อความใหม่:', data);

                if (!data.room && !data.sessionId) {
                    console.error('ข้อมูลข้อความไม่ครบถ้วน: ไม่มี room หรือ sessionId');
                    return;
                }

                const roomId = data.room || data.sessionId;
                updateConversationInList({...data, room: roomId});

                if (roomId === adminState.currentSessionId) {
                    addMessageToChat(data);
                } else {
                    if (data.sender === 'user') {
                        showNotification(`มีข้อความใหม่จากผู้ใช้ในห้อง ${roomId}`);
                    }
                }
            });

            // รับการแจ้งเตือนเมื่อมีผู้ใช้ต้องการติดต่อแอดมิน
            channel.listen('user_request_agent', (data) => {
                console.log('ผู้ใช้ต้องการติดต่อแอดมิน:', data);
                showNotification(`ผู้ใช้ ${data.userInfo?.name || 'ไม่ระบุชื่อ'} ต้องการติดต่อแอดมิน`);
                loadConversations();
            });

            // รับการแจ้งเตือนการเปลี่ยนสถานะแอดมิน
            channel.listen('admin_status_change', (data) => {
                console.log('การเปลี่ยนสถานะแอดมิน:', data);

                const roomId = data.room || data.sessionId;
                if (roomId === adminState.currentSessionId) {
                    adminState.adminActive = data.adminActive;
                    updateAdminStatusBtn();
                }
            });

        }).catch((error) => {
            console.error('เกิดข้อผิดพลาดในการเชื่อมต่อ PieSocket:', error);
            return false;
        });

        return true;
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการเชื่อมต่อ PieSocket:', error);
        return false;
    }
}

  // ปรับปรุงฟังก์ชัน loadConversations ให้เป็นแบบ Promise
function loadConversations() {
    console.log('กำลังโหลดรายการการสนทนา...');

    // คืนค่า Promise เพื่อจัดการกับการโหลดข้อมูล
    return new Promise((resolve, reject) => {
        // เก็บข้อมูลที่สำคัญไว้
        const currentSession = adminState.currentSessionId;
        const oldConversations = {...adminState.conversations}; // เก็บข้อมูลเดิมทั้งหมดไว้

        const apiUrl = `${adminState.apiBaseUrl}/chat/lists?web_id=${adminState.currentWebId}`;

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${adminState.apiToken}`
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('ข้อมูลที่ได้รับจาก API:', data);

            // แก้ไขตรงนี้: ตรวจสอบข้อมูลที่ถูกต้อง โดยดูที่ data.data แทน data.rooms
            if (data.status === "success" && Array.isArray(data.data) && data.data.length > 0) {
                console.log('โหลดการสนทนาสำเร็จ:', data.data.length, 'รายการ');

                // เก็บข้อมูลห้องปัจจุบันไว้ก่อน
                const currentConversation = currentSession ? adminState.conversations[currentSession] : null;

                // รีเซ็ตข้อมูลเดิม แต่ระวังอย่าลบข้อมูลห้องปัจจุบัน
                if (!currentSession) {
                    // ถ้าไม่มีห้องที่เปิดอยู่ ให้รีเซ็ตข้อมูลทั้งหมด
                    adminState.conversations = {};
                }

                data.data.sort((a, b) => {
                        const timeA = a.update_time || (a.message && a.message.create_date) || 0;
                        const timeB = b.update_time || (b.message && b.message.create_date) || 0;
                        return timeA - timeB; // เรียงจากเก่าไปใหม่ (ให้ตรงกับ socket)
                });

                // แปลงข้อมูลจาก API เป็นรูปแบบที่ต้องการใช้
                data.data.forEach(room => {
                        // ตรวจสอบรูปแบบข้อมูลที่ถูกต้อง
                        const roomId = room.ref_room_id || room.room_id;

                        // ข้ามห้องที่กำลังเปิดอยู่
                        if (roomId === currentSession) {
                            return;
                        }

                        // เช็คข้อความล่าสุดเพื่อหลีกเลี่ยงการซ้ำซ้อน
                        const message = room.message || {};
                        const lastMessage = Array.isArray(message) && message.length > 0
                            ? message[0]
                            : (typeof message === 'object' ? message : null);

                        // เพิ่มการเช็คข้อมูลซ้ำซ้อน
                        const existingConv = adminState.conversations[roomId];
                        if (existingConv && lastMessage) {
                            // ถ้ามีข้อมูลเดิมอยู่แล้ว และเวลาล่าสุดของข้อมูลเดิมใหม่กว่า ให้ข้าม
                            const existingTime = existingConv.lastActivity || 0;
                            const newTime = lastMessage.create_date || lastMessage.timestamp || room.update_time || 0;
                            if (existingTime > newTime) {
                                return;
                            }
                        }

                    adminState.conversations[roomId] = {
                        sessionId: roomId,
                        roomId: roomId,
                        webId: adminState.currentWebId,
                        userInfo: room.contact_info || {},
                        status: room.status_reply ? 'answered' : 'waiting',
                        lastActivity: room.update_time || Date.now(),
                        lastMessage: lastMessage ? {
                            text: lastMessage.message || lastMessage.detail || '',
                            sender: lastMessage.sender || 'user',
                            timestamp: lastMessage.create_date || lastMessage.timestamp || Date.now()
                        } : null
                    };
                });

                // คืนค่าข้อมูลห้องปัจจุบันกลับไป ถ้ามี
                if (currentConversation && currentSession) {
                    adminState.conversations[currentSession] = currentConversation;
                    console.log('คงข้อมูลห้องแชทปัจจุบันไว้:', currentSession);
                }

                updateConversationCounts(Object.values(adminState.conversations));
                renderConversationList();

                resolve(adminState.conversations);

            } else {
                console.error('ข้อมูลไม่ถูกต้องหรือไม่พบการสนทนา:', data);

                // ถ้าไม่มีข้อมูลใหม่ ให้คงข้อมูลเดิมไว้ก่อน
                adminState.conversations = oldConversations;

                // อัปเดตจำนวนการสนทนา
                updateConversationCounts(Object.values(adminState.conversations));

                // ถ้าข้อมูลเดิมก็ไม่มี จึงแสดงข้อความว่าไม่พบข้อมูล
                if (Object.keys(adminState.conversations).length === 0) {
                    elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ไม่พบข้อมูลการสนทนา</td></tr>';
                } else {
                    // ถ้ามีข้อมูลเดิม ให้แสดงข้อมูลนั้นต่อไป
                    renderConversationList();
                }

                // ผิดพลาด: แต่ยังคงใช้ข้อมูลเดิมได้
                resolve(adminState.conversations);
            }

            if (data.status === "success" && Array.isArray(data.data) && data.data.length > 0) {
                // เก็บแคช
                adminState.cachedData = {...data};
            } else {
                // ถ้าไม่สำเร็จ ให้ใช้ข้อมูลจากแคชถ้ามี
                if (adminState.cachedData.status === "success" &&
                    Array.isArray(adminState.cachedData.data) &&
                    adminState.cachedData.data.length > 0) {

                    console.log('ใช้ข้อมูลจากแคช');
                    data = {...adminState.cachedData};
                }
            }
        })
        .catch(error => {
            console.error('เกิดข้อผิดพลาดในการโหลดการสนทนา:', error);

            // ในกรณีที่เกิดข้อผิดพลาด ให้คงข้อมูลเดิมไว้
            adminState.conversations = oldConversations;

            // แสดงข้อความผิดพลาด ถ้าไม่มีข้อมูล
            if (Object.keys(adminState.conversations).length === 0) {
                elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message + '</td></tr>';
            } else {
                // ในกรณีที่มีข้อมูลเดิม ให้แสดงข้อมูลนั้นต่อไป
                renderConversationList();

                // และแสดงการแจ้งเตือนเพื่อให้ผู้ใช้ทราบว่ามีข้อผิดพลาด
                showNotification('ไม่สามารถอัปเดตรายการแชท: ' + error.message, 'error');
            }

            // ผิดพลาด: แต่ยังคงใช้ข้อมูลเดิมได้
            reject(error);
        });
    });
}

    // อัปเดตจำนวนการสนทนาในแต่ละแท็บ
    function updateConversationCounts(conversations) {
        const waitingCount = conversations.filter(conv => conv.status === 'waiting').length;
        const answeredCount = conversations.filter(conv => conv.status === 'answered').length;
        const totalCount = conversations.length;

        if (elements.waitingCount) elements.waitingCount.textContent = `(${waitingCount})`;
        if (elements.answeredCount) elements.answeredCount.textContent = `(${answeredCount})`;
if (elements.allCount) elements.allCount.textContent = `(${totalCount})`;
}

// แสดงรายการการสนทนา
function renderConversationList() {
    // ดึงสถานะแท็บที่กำลังเลือกอยู่
    const activeTab = document.querySelector('.tab.active');
    const currentStatus = activeTab ? activeTab.dataset.status : 'all';

    // ดึงข้อความค้นหา
    const searchText = elements.searchInput.value.trim().toLowerCase();

    // กรองการสนทนาตามสถานะและข้อความค้นหา
    let filteredConversations = Object.values(adminState.conversations);

    // กรองตามสถานะ (waiting, answered, all)
    if (currentStatus !== 'all') {
        filteredConversations = filteredConversations.filter(conv => conv.status === currentStatus);
    }

    // กรองตามข้อความค้นหา
    if (searchText) {
        filteredConversations = filteredConversations.filter(conv => {
            const userInfo = conv.userInfo || {};
            const name = (userInfo.name || '').toLowerCase();
            const email = (userInfo.email || '').toLowerCase();
            const phone = (userInfo.phone || '').toLowerCase();
            const lastMessage = conv.lastMessage && conv.lastMessage.text ? conv.lastMessage.text.toLowerCase() : '';

            return name.includes(searchText) ||
                   email.includes(searchText) ||
                   phone.includes(searchText) ||
                   lastMessage.includes(searchText);
        });
    }

    // เรียงลำดับตามเวลาล่าสุด
    filteredConversations.sort((a, b) => {
        // ใช้เวลาล่าสุดในการเรียง (lastActivity หรือ timestamp ของ lastMessage)
        const timeA = a.lastActivity || (a.lastMessage && a.lastMessage.timestamp) || 0;
        const timeB = b.lastActivity || (b.lastMessage && b.lastMessage.timestamp) || 0;
        return timeB - timeA; // เรียงจากใหม่ไปเก่า เพื่อให้ข้อความล่าสุดขึ้นมาด้านบน
    });

    // คำนวณจำนวนหน้าทั้งหมด
    adminState.pagination.totalPages = Math.ceil(filteredConversations.length / adminState.pagination.itemsPerPage);

    // ตรวจสอบว่าหน้าปัจจุบันถูกต้องหรือไม่
    if (adminState.pagination.currentPage > adminState.pagination.totalPages) {
        adminState.pagination.currentPage = Math.max(1, adminState.pagination.totalPages);
    }

    // สร้าง HTML
    if (filteredConversations.length === 0) {
        elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ไม่พบข้อมูลการสนทนาที่ตรงกับเงื่อนไข</td></tr>';
        // ซ่อนปุ่มแบ่งหน้า
        elements.paginationContainer.style.display = 'none';
        return;
    }

    // แบ่งข้อมูลตามหน้า
    const startIndex = (adminState.pagination.currentPage - 1) * adminState.pagination.itemsPerPage;
    const endIndex = startIndex + adminState.pagination.itemsPerPage;
    const paginatedConversations = filteredConversations.slice(startIndex, endIndex);

    let html = '';

    paginatedConversations.forEach(conv => {
        const userInfo = conv.userInfo || {};
        const name = userInfo.name || 'ไม่ระบุชื่อ';
        const email = userInfo.email || '-';
        const phone = userInfo.phone || '-';

        // จัดรูปแบบเวลา
        const lastActivityDate = new Date(conv.lastActivity);
        const formattedDate = `${lastActivityDate.toLocaleDateString('th-TH')}<br>${lastActivityDate.toLocaleTimeString('th-TH')}`;

        // ข้อความล่าสุด
        let lastMessageText = '-';
        if (conv.lastMessage && conv.lastMessage.text) {
            lastMessageText = `"${conv.lastMessage.text.substring(0, 30)}${conv.lastMessage.text.length > 30 ? '...' : ''}"`;
        }

        // สถานะ
        const statusClass = conv.status === 'waiting' ? 'pending' : 'completed';
        const statusText = conv.status === 'waiting' ? 'รอตอบกลับ' : 'ตอบแล้ว';

        html += `
            <tr>
                <td>${escapeHTML(name)}</td>
                <td>${formattedDate}</td>
                <td>${escapeHTML(lastMessageText)}</td>
                <td>${escapeHTML(phone)}<br>${escapeHTML(email)}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td><button class="action-btn chat-btn" data-id="${conv.sessionId}">คุยต่อเลย</button></td>
            </tr>
        `;
    });

    elements.conversationList.innerHTML = html;

    // อัปเดตแถบแบ่งหน้า
    updatePaginationControls(filteredConversations.length);

    // เพิ่ม Event Listeners สำหรับปุ่มแชท
    document.querySelectorAll('.chat-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.dataset.id;
            openChatSession(sessionId);
        });
    });
}

function updatePaginationControls(totalItems) {
    // ตรวจสอบว่ามี container สำหรับการแบ่งหน้าหรือไม่
    if (!elements.paginationContainer) {
        console.error('ไม่พบ pagination container');
        return;
    }

    // คำนวณจำนวนหน้าทั้งหมด
    const totalPages = Math.ceil(totalItems / adminState.pagination.itemsPerPage);
    adminState.pagination.totalPages = totalPages;

    // ถ้ามีเพียงหน้าเดียว ให้ซ่อนแถบแบ่งหน้า
    if (totalPages <= 1) {
        elements.paginationContainer.style.display = 'none';
        return;
    }

    // แสดงแถบแบ่งหน้า
    elements.paginationContainer.style.display = 'flex';

    // สร้าง HTML สำหรับปุ่มแบ่งหน้า
    let paginationHTML = '';

    // ปุ่มก่อนหน้า
    const prevDisabled = adminState.pagination.currentPage <= 1 ? 'disabled' : '';
    paginationHTML += `<button class="pagination-btn prev ${prevDisabled}" ${prevDisabled}><i class="fas fa-chevron-left"></i></button>`;

    // ปุ่มหน้าแรก
    if (adminState.pagination.currentPage > 3) {
        paginationHTML += `<button class="pagination-btn page-btn" data-page="1">1</button>`;

        if (adminState.pagination.currentPage > 4) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
    }

    // ปุ่มหน้าตัวเลข
    const startPage = Math.max(1, adminState.pagination.currentPage - 1);
    const endPage = Math.min(totalPages, adminState.pagination.currentPage + 1);

    for (let i = startPage; i <= endPage; i++) {
        const active = i === adminState.pagination.currentPage ? 'active' : '';
        paginationHTML += `<button class="pagination-btn page-btn ${active}" data-page="${i}">${i}</button>`;
    }

    // ปุ่มหน้าสุดท้าย
    if (adminState.pagination.currentPage < totalPages - 2) {
        if (adminState.pagination.currentPage < totalPages - 3) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }

        paginationHTML += `<button class="pagination-btn page-btn" data-page="${totalPages}">${totalPages}</button>`;
    }

    // ปุ่มถัดไป
    const nextDisabled = adminState.pagination.currentPage >= totalPages ? 'disabled' : '';
    paginationHTML += `<button class="pagination-btn next ${nextDisabled}" ${nextDisabled}><i class="fas fa-chevron-right"></i></button>`;

    // อัปเดต HTML
    elements.paginationContainer.innerHTML = paginationHTML;

    // เพิ่ม Event Listeners สำหรับปุ่มแบ่งหน้า
    elements.paginationContainer.querySelectorAll('.page-btn').forEach(button => {
        button.addEventListener('click', function() {
            const page = parseInt(this.dataset.page);
            adminState.pagination.currentPage = page;
            renderConversationList();
        });
    });

    // ปุ่มก่อนหน้า
    const prevButton = elements.paginationContainer.querySelector('.prev');
    if (prevButton && !prevButton.hasAttribute('disabled')) {
        prevButton.addEventListener('click', function() {
            adminState.pagination.currentPage--;
            renderConversationList();
        });
    }

    // ปุ่มถัดไป
    const nextButton = elements.paginationContainer.querySelector('.next');
    if (nextButton && !nextButton.hasAttribute('disabled')) {
        nextButton.addEventListener('click', function() {
            adminState.pagination.currentPage++;
            renderConversationList();
        });
    }
}

function resetPagination() {
    adminState.pagination.currentPage = 1;
    renderConversationList();
}

// เปิดห้องแชท
function openChatSession(sessionId) {
  console.log('เปิดห้องแชท:', sessionId);

  // ดึงข้อมูลห้องแชทจาก state
  const conversation = adminState.conversations[sessionId];

  // บันทึก sessionId และ roomId ปัจจุบัน
  adminState.currentSessionId = sessionId;
  adminState.currentRoomId = conversation ? (conversation.roomId || sessionId) : sessionId;

  // *** เพิ่มส่วนนี้: เปิด Admin Active อัตโนมัติ ***
  adminState.adminActive = true;
  updateAdminStatusBtn();

  if (adminState.adminChannel) {
            adminState.adminChannel.publish('admin_status_change', {
                type: 'admin_status_change',
                adminActive: true,
                timestamp: Date.now(),
                room: adminState.currentSessionId,
                adminId: adminState.adminInfo.id,
                adminName: adminState.adminInfo.name,
                adminImage: adminState.adminInfo.image,
                sessionId: adminState.currentSessionId, // เพิ่ม sessionId
                platform: 'ownweb'
            });
        }

  // แสดงการแจ้งเตือน
  showNotification('แอดมินกำลังให้บริการในห้องแชทนี้');
  // *** สิ้นสุดส่วนที่เพิ่ม ***

  // แสดงหน้าต่างแชท
  elements.chatPanel.style.display = 'flex';
  elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">กำลังโหลดข้อความ...</div>';

  // เรียก API เพื่อโหลดประวัติการสนทนา
  const webId = adminState.currentWebId;
  const roomId = adminState.currentRoomId;
  const apiUrl = `${adminState.apiBaseUrl}/chat/open?web_id=${webId}&room_id=${roomId}`;

  console.log('เรียก API เพื่อโหลดประวัติการสนทนา:', apiUrl);

  fetch(apiUrl, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${adminState.apiToken}`
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('ได้รับข้อมูลจาก API:', data);

    if (data.status === "success") {
      console.log('โหลดข้อมูลการสนทนาสำเร็จ');

      // อัปเดตข้อมูลลูกค้า
      const userInfo = data.contact_info || {};
      const name = userInfo.name || 'ไม่ระบุชื่อ';
      const email = userInfo.email || '';
      const phone = userInfo.phone || '';
      const contact = [email, phone].filter(Boolean).join(' • ') || 'ไม่มีข้อมูลติดต่อ';

      elements.chatCustomerName.textContent = name;
      elements.chatCustomerContact.textContent = contact;

      // *** เปลี่ยนบรรทัดนี้: กำหนดให้ admin active เสมอ ***
      adminState.adminActive = true; // เดิมคือ: data.status_reply === 1
      updateAdminStatusBtn();

      // แสดงประวัติการสนทนา
      if (data.messages && data.messages.length > 0) {
        // ตรวจสอบข้อมูลทุกข้อความที่ได้รับจาก API
        data.messages.forEach(msg => {
          console.log(`ข้อความ ID: ${msg.create_date} Type: ${msg.type} Sender: ${msg.sender}`);

          if (msg.options) {
            console.log(`มี options: ${JSON.stringify(msg.options)}`);
          }

          if (msg.type === 2) {
            console.log(`ข้อความประเภท 2 (options): ${JSON.stringify(msg)}`);
          }
        });

        displayChatHistory(data.messages);
      } else {
        elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">ยังไม่มีข้อความในการสนทนานี้</div>';
      }
    } else {
      elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:red;">ไม่พบข้อมูลการสนทนา</div>';
    }
  })
  .catch(error => {
    console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลการสนทนา:', error);
    elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
  });

  if (adminState.adminChannel) {
        console.log('เข้าร่วมห้อง:', sessionId);
        adminState.adminChannel.publish('join', {
        room: sessionId,
        sessionId: adminState.currentSessionId, // เพิ่ม sessionId
        platform: 'ownweb'
        });
    }
}


// แสดงประวัติการสนทนา
function displayChatHistory(messages) {
    if (!messages || messages.length === 0) {
        elements.adminChatMessages.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">ยังไม่มีข้อความในการสนทนานี้</div>';
        return;
    }

    // ล้างเนื้อหาก่อนแสดงข้อความใหม่
    elements.adminChatMessages.innerHTML = '';

    // สำคัญ: เรียงข้อความจากเก่าไปใหม่ก่อนแสดงผล
    // เนื่องจาก messages จาก API เรียงจากใหม่ไปเก่า
    const sortedMessages = [...messages].sort((a, b) => {
        return a.create_date - b.create_date;
    });

    // แสดงข้อความตามลำดับที่เรียงใหม่
    sortedMessages.forEach(msg => {
        // แปลงข้อมูลให้ตรงกับรูปแบบที่ใช้ในฟังก์ชัน addMessageToChat
        const messageData = {
            sender: msg.sender,
            text: msg.message || '', // รองรับทั้ง message และ text
            timestamp: msg.create_date,
            adminName: msg.adminName || (msg.sender === 'admin' ? adminState.adminInfo.name : undefined),
            room: adminState.currentSessionId
        };

        // ตรวจสอบข้อมูลเพิ่มเติม (เช่น item_list สำหรับแสดงรายการอสังหาริมทรัพย์)
        if (msg.type === 3 && msg.item_list && Array.isArray(msg.item_list)) {
            messageData.payload = {
                richContent: [
                    [
                        {
                            type: "info",
                            title: msg.message || "รายการอสังหาริมทรัพย์",
                            subtitle: `พบทั้งหมด ${msg.item_list.length} รายการ`
                        },
                        ...msg.item_list.map(item => ({
                            type: "custom_card",
                            property_data: {
                                id: item.web_id,
                                imageUrl: item.photo || '',
                                title: item.name || 'ไม่ระบุชื่อ',
                                location: item.zone_name || 'ไม่ระบุที่ตั้ง',
                                price: item.price || '-',
                                tag: item.tag || 'ขาย',
                                link: item.link || '#'
                            }
                        }))
                    ]
                ]
            };

            // เพิ่มปุ่ม "ดูเพิ่มเติม" ถ้ามี
            if (msg.more && msg.more.link) {
                messageData.payload.richContent[0].push({
                    type: "button",
                    options: [
                        {
                            text: msg.more.txt || "ดูเพิ่มเติม",
                            link: msg.more.link
                        }
                    ]
                });
            }
        } else if (msg.type === 2 && msg.options && Array.isArray(msg.options)) {
            // แสดงตัวเลือกเป็น chips
            messageData.payload = {
                richContent: [
                    [
                        {
                            type: "chips",
                            options: msg.options.map(option => ({ text: option }))
                        }
                    ]
                ]
            };
        }

        addMessageToChat(messageData);
    });

    // เลื่อนไปที่ข้อความล่าสุด
    scrollToBottom();
}

// เพิ่มฟังก์ชัน renderChips เพื่อใช้ในฟังก์ชัน addMessageToChat
function renderChips(item) {
    if (!item || !item.options || !Array.isArray(item.options) || item.options.length === 0) {
        return '';
    }

    return `
        <div class="rich-chips">
            ${item.options.map(option => {
                const text = typeof option === 'object' ? option.text || '' : option || '';
                return `<span class="rich-chip">${escapeHTML(text)}</span>`;
            }).join('')}
        </div>
    `;
}

// แก้ไขฟังก์ชัน addMessageToChat เพื่อเรียกใช้ฟังก์ชัน renderChips
function addMessageToChat(data) {
    // ตรวจสอบว่าเป็นข้อความซ้ำหรือไม่
    if (isMessageDuplicate(data.timestamp)) {
        console.log('ข้อความซ้ำ ไม่แสดงซ้ำ');
        return;
    }

    // สร้าง element ใหม่สำหรับข้อความ
    const messageDiv = document.createElement('div');

    // กำหนด class ตามประเภทผู้ส่ง
    if (data.sender === 'user') {
        messageDiv.className = 'message user'; // ผู้ใช้ฝั่งขวา
    } else if (data.sender === 'bot') {
        messageDiv.className = 'message bot'; // บอทฝั่งซ้าย
    } else if (data.sender === 'admin') {
        messageDiv.className = 'message admin'; // แอดมินฝั่งซ้าย
    } else if (data.sender === 'system') {
        messageDiv.className = 'message system'; // ข้อความระบบตรงกลาง
    }

    // ตั้งค่า attribute สำหรับเช็คข้อความซ้ำ
    messageDiv.setAttribute('data-message-id', data.timestamp);

    // สร้างเนื้อหาข้อความตามประเภทผู้ส่ง
    let messageHTML = '';

    if (data.sender === 'user') {
        // ข้อความจากผู้ใช้
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
            </div>
        `;
    } else if (data.sender === 'bot') {
        // ข้อความจากบอท

        // เริ่มต้นด้วยข้อความพื้นฐาน
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
        `;

        // ถ้ามี payload ให้เพิ่ม rich content
        if (data.payload) {
            const richContentHtml = renderRichContent(data.payload);
            if (richContentHtml) {
                messageHTML += richContentHtml;
            }
        }

        // ถ้ามี options (type 2) ให้แสดงเป็น chips
        if (data.type === "2" && data.options && Array.isArray(data.options) && data.options.length > 0) {
            // แปลง options ให้อยู่ในรูปแบบที่ renderChips ต้องการ
            const options = data.options.map(opt => {
                return typeof opt === 'object' ? opt : { text: opt };
            });

            const chipsItem = {
                type: 'chips',
                options: options
            };

            // สร้าง HTML สำหรับ chips
            const chipsHtml = renderChips(chipsItem);
            messageHTML += chipsHtml;
        }

        // เพิ่ม label ผู้ส่งและปิด div
        messageHTML += `
                <small>ส่งโดย : บอท</small>
            </div>
        `;
    } else if (data.sender === 'admin') {
        // ข้อความจากแอดมิน
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
                <small>ส่งโดย : ${escapeHTML(data.adminName || adminState.adminInfo.name)}</small>
            </div>
        `;
    } else if (data.sender === 'system') {
        // ข้อความจากระบบ
        messageHTML = `
            <div class="message-content">
                <p>${escapeHTML(data.text)}</p>
            </div>
        `;
    }

    // ใส่เนื้อหาข้อความ
    messageDiv.innerHTML = messageHTML;

    // เพิ่มข้อความลงในพื้นที่แชท
    elements.adminChatMessages.appendChild(messageDiv);

    // ถ้าเป็นข้อความที่มี chips หรือ rich content ให้เพิ่ม event listeners
    if ((data.type === "2" && data.options) || data.payload) {
        // ถ้ามีฟังก์ชัน addInteractiveListeners ก็เรียกใช้
        if (typeof addInteractiveListeners === 'function') {
            addInteractiveListeners(messageDiv);
        }
    }

    // เลื่อนไปที่ข้อความล่าสุด
    scrollToBottom();
}

// ตรวจสอบข้อความซ้ำ
function isMessageDuplicate(messageId) {
    return document.querySelector(`.message[data-message-id="${messageId}"]`) !== null;
}

function renderChips(item) {
    if (!item || !item.options || !Array.isArray(item.options) || item.options.length === 0) {
        return '';
    }

    return `
        <div class="rich-chips">
            ${item.options.map(option => {
                const text = typeof option === 'object' ? option.text || '' : option || '';
                return `<span class="rich-chip">${escapeHTML(text)}</span>`;
            }).join('')}
        </div>
    `;
}

// เลื่อนหน้าต่างแชทไปที่ล่างสุด
function scrollToBottom() {
    elements.adminChatMessages.scrollTop = elements.adminChatMessages.scrollHeight;
}

// ปิดหน้าต่างแชท
function closeChatPanel() {
    // *** เพิ่มส่วนนี้: ปิด Admin Active เมื่อปิดแชท ***
    if (adminState.currentSessionId && adminState.adminActive) {
        // ตั้งค่า admin เป็น inactive
        adminState.adminActive = false;
        updateAdminStatusBtn();

        if (adminState.adminChannel) {
            adminState.adminChannel.publish('admin_status_change', {
                type: 'admin_status_change',
                adminActive: false,
                timestamp: Date.now(),
                room: adminState.currentSessionId,
                adminId: adminState.adminInfo.id,
                adminName: adminState.adminInfo.name,
                adminImage: adminState.adminInfo.image,
                sessionId: adminState.currentSessionId, // เพิ่ม sessionId
                platform: 'ownweb'
            });
        }

        // แสดงการแจ้งเตือน
        showNotification('แอดมินออกจากการให้บริการแล้ว');
    }
    // *** สิ้นสุดส่วนที่เพิ่ม ***

    // ออกจากห้องแชท
    if (adminState.currentSessionId && adminState.adminChannel) {
        adminState.adminChannel.publish('leave', {
                room: adminState.currentSessionId,
                sessionId: adminState.currentSessionId, // เพิ่ม sessionId
                platform: 'ownweb',
                });
        console.log('ออกจากห้อง:', adminState.currentSessionId);
    }

    adminState.currentSessionId = null;
    elements.chatPanel.style.display = 'none';
}
let isUnloading = false;

function handlePageUnload() {
    // ป้องกันการเรียกซ้ำ
    if (isUnloading) {
        console.log('กำลังประมวลผล unload อยู่แล้ว ข้ามการทำงานซ้ำ');
        return;
    }

    isUnloading = true;

    // ถ้ามีการเปิดแชทและแอดมินกำลัง active อยู่

    if (adminState.currentSessionId && adminState.adminActive && adminState.adminChannel) {
        adminState.adminChannel.publish('admin_status_change', {
            type: 'admin_status_change',
            adminActive: false,
            timestamp: Date.now(),
            room: adminState.currentSessionId,
            adminId: adminState.adminInfo.id,
            adminName: adminState.adminInfo.name,
                adminImage: adminState.adminInfo.image,
                sessionId: adminState.currentSessionId, // เพิ่ม sessionId
                platform: 'ownweb',
        });
        adminState.adminChannel.publish('leave', { room: adminState.currentSessionId,
                sessionId: adminState.currentSessionId, // เพิ่ม sessionId
                platform: 'ownweb',  });
    }

    // รีเซ็ตตัวแปรหลังจาก 1 วินาที (กรณีที่ไม่ได้ปิดหน้าจริงๆ)
    setTimeout(() => {
        isUnloading = false;
    }, 1000);
}


function handlePageLoad() {
    // รีเซ็ตตัวแปร unloading
    isUnloading = false;

    // เมื่อโหลดหน้าใหม่ ให้รีเซ็ต admin status
    adminState.adminActive = false;
    adminState.currentSessionId = null;

    // ซ่อนหน้าต่างแชท
    if (elements.chatPanel) {
        elements.chatPanel.style.display = 'none';
    }

    // อัปเดตปุ่มสถานะ
    updateAdminStatusBtn();

    console.log('หน้าเว็บโหลดใหม่ - รีเซ็ต admin status');
}


// ส่งข้อความจากแอดมิน// ส่งข้อความจากแอดมิน
function sendAdminMessage() {
  const message = elements.adminChatInput.value.trim();
  if (!message || !adminState.currentSessionId) return;

  const timestamp = Date.now();
  const roomId = adminState.currentRoomId || adminState.currentSessionId;
  const webId = adminState.currentWebId;

  // แสดงข้อความในหน้าต่างแชท
  addMessageToChat({
    sender: 'admin',
    text: message,
    adminName: adminState.adminInfo.name,
    timestamp: timestamp,
    room: adminState.currentSessionId
  });

  // เตรียมข้อมูลสำหรับส่ง API
  const formData = new FormData();
  formData.append('room_id', roomId);
  formData.append('web_id', webId);
  formData.append('detail', message);
  formData.append('type', '1'); // ประเภทข้อความปกติ
  formData.append('sender', 'admin');
  formData.append('options', ''); // ไม่มีตัวเลือกเพิ่มเติม

  // ส่งข้อความผ่าน API
  fetch(`${adminState.apiBaseUrl}/chat/send/sms`, {
    method: 'POST',
        headers: {
            'Authorization': `Bearer ${adminState.apiToken}` // เพิ่ม Bearer Token ในส่วน headers
        },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    console.log('ส่งข้อความผ่าน API สำเร็จ:', data);

    // อัปเดตสถานะ conversation ในรายการเป็น 'answered'
    if (adminState.conversations[adminState.currentSessionId]) {
      adminState.conversations[adminState.currentSessionId].status = 'answered';
      renderConversationList();
    }
  })
  .catch(error => {
    console.error('เกิดข้อผิดพลาดในการส่งข้อความผ่าน API:', error);
    showNotification('เกิดข้อผิดพลาดในการส่งข้อความ', 'error');
  });


  if (adminState.adminChannel) {
    adminState.adminChannel.publish('new_message', {
        sender: 'admin',
        text: message,
        adminId: adminState.adminInfo.id,
        adminName: adminState.adminInfo.name,
        timestamp: timestamp,
        room: adminState.currentSessionId,
                sessionId: adminState.currentSessionId, // เพิ่ม sessionId
                platform: 'ownweb',
    });
}


  // เคลียร์ช่องข้อความ
  elements.adminChatInput.value = '';
  elements.adminChatInput.focus();
}

// สลับสถานะแอดมิน
function toggleAdminStatus() {
    if (!adminState.currentSessionId) return;

    adminState.adminActive = !adminState.adminActive;
    updateAdminStatusBtn();

    if (adminState.adminChannel) {
            adminState.adminChannel.publish('admin_status_change', {
                type: 'admin_status_change',
                adminActive: adminState.adminActive,
                timestamp: Date.now(),
                room: adminState.currentSessionId,
                adminId: adminState.adminInfo.id,
                adminName: adminState.adminInfo.name,
                adminImage: adminState.adminInfo.image,
                sessionId: adminState.currentSessionId, // เพิ่ม sessionId
                platform: 'ownweb',
            });
        }

    // แสดงการแจ้งเตือน
    showNotification(`สถานะแอดมิน: ${adminState.adminActive ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}`);
}

// อัปเดตปุ่มสถานะแอดมิน
function updateAdminStatusBtn() {
    if (adminState.adminActive) {
        elements.adminStatusBtn.textContent = 'แอดมินกำลังให้บริการ';
        elements.adminStatusBtn.classList.add('active');
    } else {
        elements.adminStatusBtn.textContent = 'เปิดใช้งานแอดมิน';
        elements.adminStatusBtn.classList.remove('active');
    }
}

// อัปเดตการสนทนาในรายการเมื่อได้รับข้อความใหม่
function updateConversationInList(data) {
    if (!data || !data.room) return;

    // อัปเดตหรือสร้างข้อมูลการสนทนาใหม่
    if (!adminState.conversations[data.room]) {
        adminState.conversations[data.room] = {
            sessionId: data.room,
            userInfo: { name: 'ไม่ระบุชื่อ' },
            status: data.sender === 'user' ? 'waiting' : 'answered',
            lastActivity: data.timestamp || Date.now(),
            lastMessage: {
                text: data.text,
                sender: data.sender,
                timestamp: data.timestamp || Date.now()
            }
        };
    } else {
        // อัปเดตข้อมูลที่มีอยู่แล้ว
        adminState.conversations[data.room].lastActivity = data.timestamp || Date.now();
        adminState.conversations[data.room].lastMessage = {
            text: data.text,
            sender: data.sender,
            timestamp: data.timestamp || Date.now()
        };

        // อัปเดตสถานะ
        if (data.sender === 'user') {
            adminState.conversations[data.room].status = 'waiting';
        } else if (data.sender === 'admin') {
            adminState.conversations[data.room].status = 'answered';
        }
    }

    // อัปเดตการแสดงผล
    updateConversationCounts(Object.values(adminState.conversations));
    renderConversationList();
}

// รองรับการแสดง Rich Content
function renderRichContent(payload) {
    if (!payload || !payload.richContent || !payload.richContent.length) {
        return '';
    }

    let html = '<div class="rich-content-container">';

    payload.richContent[0].forEach(item => {
        if (item.type === 'info') {
            html += `
                <div class="rich-info">
                    <h4>${escapeHTML(item.title || '')}</h4>
                    <p>${escapeHTML(item.subtitle || '')}</p>
                </div>
            `;
        } else if (item.type === 'button') {
            html += '<div class="rich-buttons">';
            if (item.options && Array.isArray(item.options)) {
                item.options.forEach(btn => {
                    html += `<button class="rich-button">${escapeHTML(btn.text || 'Button')}</button>`;
                });
            } else if (item.text) {
                html += `<button class="rich-button">${escapeHTML(item.text)}</button>`;
            }
            html += '</div>';
        } else if (item.type === 'chips') {
            html += '<div class="rich-chips">';
            if (item.options && Array.isArray(item.options)) {
                item.options.forEach(chip => {
                    html += `<span class="rich-chip">${escapeHTML(chip.text || '')}</span>`;
                });
            }
            html += '</div>';
        } else if (item.type === 'image') {
            const imgSrc = item.rawUrl || (item.image && item.image.src ? item.image.src.rawUrl : '');
            if (imgSrc) {
                html += `<div class="rich-image"><img src="${escapeHTML(imgSrc)}" alt="Image"></div>`;
            }
        } else if (item.type === 'custom_card' && item.property_data) {
            const propData = item.property_data;
            html += `
                <div class="property-card">
                    <div class="property-image">
                        <img src="${escapeHTML(propData.imageUrl || '')}" alt="Property">
                        <div class="property-tag">${escapeHTML(propData.tag || 'ขาย')}</div>
                    </div>
                    <div class="property-info">
                        <div class="property-title">${escapeHTML(propData.title || 'ไม่ระบุชื่อ')}</div>
                        <div class="property-location">${escapeHTML(propData.location || 'ไม่ระบุที่ตั้ง')}</div>
                        <div class="property-price">฿${escapeHTML(propData.price || '-')}</div>
                    </div>
                </div>
            `;
        }
    });

    html += '</div>';
    return html;
}

// แสดงการแจ้งเตือน
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `admin-notification ${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}

// ป้องกัน XSS
function escapeHTML(text) {
    if (!text) return '';
    return text
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// เริ่มต้นการทำงาน
function init() {
    // *** ใช้เพียง beforeunload เท่านั้น เพื่อป้องกันการยิงซ้ำ ***
    window.addEventListener('beforeunload', handlePageUnload);

    // *** ลบ Event Listeners อื่นที่ซ้ำซ้อน ***
    // window.addEventListener('unload', handlePageUnload);        // ลบบรรทัดนี้
    // window.addEventListener('pagehide', handlePageUnload);      // ลบบรรทัดนี้

    // *** เพิ่ม Event Listener สำหรับการโหลดหน้าใหม่ ***
    window.addEventListener('load', handlePageLoad);

    connectSocket();

    // ตั้งค่า event listeners

    // การคลิกแท็บ
    elements.tabButtons.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();

            // ลบคลาส active จากทุกแท็บ
            elements.tabButtons.forEach(t => t.classList.remove('active'));

            // เพิ่มคลาส active ให้แท็บที่คลิก
            this.classList.add('active');

            // รีเซ็ตการแบ่งหน้าเมื่อเปลี่ยนแท็บ
            resetPagination();
        });
    });

    // การค้นหา
    elements.searchInput.addEventListener('input', function() {
        // รีเซ็ตการแบ่งหน้าเมื่อมีการค้นหา
        resetPagination();
    });

    // การส่งข้อความ
    elements.adminSendBtn.addEventListener('click', sendAdminMessage);

    // การกด Enter ในช่องข้อความ
    elements.adminChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendAdminMessage();
        }
    });

    // การปิดหน้าต่างแชท
    elements.closeChatBtn.addEventListener('click', closeChatPanel);

    // การสลับสถานะแอดมิน
    elements.adminStatusBtn.addEventListener('click', toggleAdminStatus);

    // โหลดรายการการสนทนาเริ่มต้น
    loadConversations();

    adminState.isLoading = false;
    adminState.lastLoadTime = 0;

    setInterval(() => {
        // ไม่โหลดถ้าเพิ่งโหลดไปเมื่อไม่นาน (ภายใน 3 วินาที)
        const now = Date.now();
        if (now - adminState.lastLoadTime < 3000) {
            console.log('เพิ่งโหลดข้อมูลไปเมื่อไม่นาน รอก่อน');
            return;
        }

        // ตรวจสอบว่ากำลังโหลดข้อมูลอยู่หรือไม่
        if (adminState.isLoading) {
            console.log('กำลังโหลดข้อมูลอยู่แล้ว รอรอบถัดไป');
            return;
        }

        // ถ้ากำลังเปิดห้องแชทอยู่ ไม่ต้องโหลดใหม่ทั้งหมด
        if (adminState.currentSessionId) {
            console.log('มีการเปิดห้องแชทอยู่ จึงไม่โหลดรายการทั้งหมดใหม่');
            // อาจเรียกฟังก์ชันที่โหลดเฉพาะรายการ แต่ไม่กระทบห้องปัจจุบัน
        } else {
            console.log('ไม่มีการเปิดห้องแชท โหลดรายการใหม่');

            // ตั้งค่าสถานะการโหลด
            adminState.isLoading = true;

            // โหลดข้อมูลใหม่ และรีเซ็ตสถานะเมื่อเสร็จสิ้น
            loadConversations()
                .then(() => {
                    adminState.lastLoadTime = Date.now();
                })
                .finally(() => {
                    adminState.isLoading = false;
                });
        }
    }, 5000);
}

// เริ่มทำงานเมื่อโหลดหน้าเสร็จ
document.addEventListener('DOMContentLoaded', init);
</script>
<script>
        // เพิ่มสถานะการเรียงลำดับ
        const sortState = {
            column: 'lastActivity', // คอลัมน์เริ่มต้น
            direction: 'desc' // ทิศทางเริ่มต้น (ใหม่ไปเก่า)
        };

        // ฟังก์ชันเริ่มต้นระบบการเรียงลำดับ
        function initializeSorting() {
            // เพิ่ม event listeners ให้กับหัวตารางที่สามารถเรียงได้
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const sortBy = this.dataset.sort;
                    handleColumnSort(sortBy);
                });
            });

            // ตั้งค่าเริ่มต้นให้กับคอลัมน์แรก
            updateSortIndicators();
        }

        // ฟังก์ชันจัดการการคลิกหัวตาราง
        function handleColumnSort(columnName) {
            // ถ้าคลิกคอลัมน์เดิม ให้สลับทิศทาง
            if (sortState.column === columnName) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // ถ้าคลิกคอลัมน์ใหม่ ให้เรียงจากน้อยไปมาก
                sortState.column = columnName;
                sortState.direction = 'asc';

                // ยกเว้นคอลัมน์เวลาให้เรียงจากใหม่ไปเก่าเป็นค่าเริ่มต้น
                if (columnName === 'lastActivity') {
                    sortState.direction = 'desc';
                }
            }

            // อัปเดตสัญลักษณ์การเรียงลำดับ
            updateSortIndicators();

            // รีเซ็ตการแบ่งหน้าและแสดงผลใหม่
            adminState.pagination.currentPage = 1;
            renderConversationList();

            console.log(`เรียงตาม: ${columnName} (${sortState.direction})`);
        }

        // ฟังก์ชันอัปเดตสัญลักษณ์การเรียงลำดับ
        function updateSortIndicators() {
            // ลบ class การเรียงลำดับออกจากทุกหัวข้อ
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // เพิ่ม class การเรียงลำดับให้กับหัวข้อที่ถูกเลือก
            const activeHeader = document.querySelector(`[data-sort="${sortState.column}"]`);
            if (activeHeader) {
                activeHeader.classList.add(`sort-${sortState.direction}`);
            }
        }

        // แก้ไขฟังก์ชัน renderConversationList เพื่อใช้การเรียงลำดับจากหัวตาราง
        function renderConversationListWithTableSort() {
            // ดึงสถานะแท็บที่กำลังเลือกอยู่
            const activeTab = document.querySelector('.tab.active');
            const currentStatus = activeTab ? activeTab.dataset.status : 'all';

            // ดึงข้อความค้นหา
            const searchText = elements.searchInput ? elements.searchInput.value.trim().toLowerCase() : '';

            // กรองการสนทนาตามสถานะและข้อความค้นหา
            let filteredConversations = Object.values(adminState.conversations);

            // กรองตามสถานะ (waiting, answered, all)
            if (currentStatus !== 'all') {
                filteredConversations = filteredConversations.filter(conv => conv.status === currentStatus);
            }

            // กรองตามข้อความค้นหา
            if (searchText) {
                filteredConversations = filteredConversations.filter(conv => {
                    const userInfo = conv.userInfo || {};
                    const name = (userInfo.name || '').toLowerCase();
                    const email = (userInfo.email || '').toLowerCase();
                    const phone = (userInfo.phone || '').toLowerCase();
                    const lastMessage = conv.lastMessage && conv.lastMessage.text ? conv.lastMessage.text.toLowerCase() : '';

                    return name.includes(searchText) ||
                           email.includes(searchText) ||
                           phone.includes(searchText) ||
                           lastMessage.includes(searchText);
                });
            }

            // เรียงลำดับตามหัวตารางที่เลือก
            filteredConversations.sort((a, b) => {
                let valueA, valueB;

                switch (sortState.column) {
                    case 'name':
                        valueA = (a.userInfo?.name || 'ไม่ระบุชื่อ').toLowerCase();
                        valueB = (b.userInfo?.name || 'ไม่ระบุชื่อ').toLowerCase();
                        break;

                    case 'lastActivity':
                        valueA = a.lastActivity || 0;
                        valueB = b.lastActivity || 0;
                        break;

                    case 'lastMessage':
                        valueA = (a.lastMessage?.text || '').toLowerCase();
                        valueB = (b.lastMessage?.text || '').toLowerCase();
                        break;

                    case 'contact':
                        const contactA = (a.userInfo?.phone || a.userInfo?.email || '').toLowerCase();
                        const contactB = (b.userInfo?.phone || b.userInfo?.email || '').toLowerCase();
                        valueA = contactA;
                        valueB = contactB;
                        break;

                    case 'status':
                        valueA = a.status || '';
                        valueB = b.status || '';
                        break;

                    default:
                        valueA = a.lastActivity || 0;
                        valueB = b.lastActivity || 0;
                }

                // เปรียบเทียบค่า
                let comparison = 0;
                if (valueA < valueB) {
                    comparison = -1;
                } else if (valueA > valueB) {
                    comparison = 1;
                }

                // ใช้ทิศทางการเรียงลำดับ
                return sortState.direction === 'desc' ? -comparison : comparison;
            });

            // คำนวณจำนวนหน้าทั้งหมด
            adminState.pagination.totalPages = Math.ceil(filteredConversations.length / adminState.pagination.itemsPerPage);

            // ตรวจสอบว่าหน้าปัจจุบันถูกต้องหรือไม่
            if (adminState.pagination.currentPage > adminState.pagination.totalPages) {
                adminState.pagination.currentPage = Math.max(1, adminState.pagination.totalPages);
            }

            // สร้าง HTML
            if (filteredConversations.length === 0) {
                elements.conversationList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ไม่พบข้อมูลการสนทนาที่ตรงกับเงื่อนไข</td></tr>';
                // ซ่อนปุ่มแบ่งหน้า
                if (elements.paginationContainer) {
                    elements.paginationContainer.style.display = 'none';
                }
                return;
            }

            // แบ่งข้อมูลตามหน้า
            const startIndex = (adminState.pagination.currentPage - 1) * adminState.pagination.itemsPerPage;
            const endIndex = startIndex + adminState.pagination.itemsPerPage;
            const paginatedConversations = filteredConversations.slice(startIndex, endIndex);

            let html = '';

            paginatedConversations.forEach(conv => {
                const userInfo = conv.userInfo || {};
                const name = userInfo.name || 'ไม่ระบุชื่อ';
                const email = userInfo.email || '-';
                const phone = userInfo.phone || '-';

                // จัดรูปแบบเวลา
                const lastActivityDate = new Date(conv.lastActivity);
                const formattedDate = `${lastActivityDate.toLocaleDateString('th-TH')}<br>${lastActivityDate.toLocaleTimeString('th-TH')}`;

                // ข้อความล่าสุด
                let lastMessageText = '-';
                if (conv.lastMessage && conv.lastMessage.text) {
                    lastMessageText = `"${conv.lastMessage.text.substring(0, 30)}${conv.lastMessage.text.length > 30 ? '...' : ''}"`;
                }

                // สถานะ
                const statusClass = conv.status === 'waiting' ? 'pending' : 'completed';
                const statusText = conv.status === 'waiting' ? 'รอตอบกลับ' : 'ตอบแล้ว';

                html += `
                    <tr>
                        <td>${escapeHTML(name)}</td>
                        <td>${formattedDate}</td>
                        <td>${escapeHTML(lastMessageText)}</td>
                        <td>${escapeHTML(phone)}<br>${escapeHTML(email)}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td><button class="action-btn chat-btn" data-id="${conv.sessionId}">คุยต่อเลย</button></td>
                    </tr>
                `;
            });

            elements.conversationList.innerHTML = html;

            // อัปเดตแถบแบ่งหน้า
            updatePaginationControls(filteredConversations.length);

            // เพิ่ม Event Listeners สำหรับปุ่มแชท
            document.querySelectorAll('.chat-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sessionId = this.dataset.id;
                    openChatSession(sessionId);
                });
            });
        }

        // แทนที่ฟังก์ชัน renderConversationList เดิม
        function renderConversationList() {
            renderConversationListWithTableSort();
        }

        // เพิ่มการเรียกใช้งานเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', function() {
            // รอให้ DOM โหลดเสร็จแล้วค่อยเรียก initializeSorting
            setTimeout(initializeSorting, 100);
        });

        // เพิ่มฟังก์ชันรีเซ็ตการเรียงลำดับ
        function resetSorting() {
            sortState.column = 'lastActivity';
            sortState.direction = 'desc';
            updateSortIndicators();
        }

        // อัปเดตฟังก์ชัน init เพื่อเรียกใช้ระบบการเรียงลำดับ
        function initWithSorting() {

            // เพิ่มการเรียกใช้ระบบการเรียงลำดับ
            initializeSorting();

        }
    </script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const settingsForm = document.getElementById('settingsForm');
        const profileImageInput = document.getElementById('profileImageInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const profilePreview = document.getElementById('profilePreview');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // โหลดข้อมูลที่บันทึกไว้
        loadSavedSettings();

        // เปิด Settings Dialog
        settingsBtn.addEventListener('click', function() {
            settingsOverlay.classList.add('show');
            hideMessages();
            loadSettingsFromAPI(); // โหลดข้อมูลจาก API
        });

        // ปิด Settings Dialog
        function closeDialog() {
            settingsOverlay.classList.remove('show');
        }

        closeSettingsBtn.addEventListener('click', closeDialog);
        cancelBtn.addEventListener('click', closeDialog);

        // ปิด Dialog เมื่อคลิกที่ overlay
        settingsOverlay.addEventListener('click', function(e) {
            if (e.target === settingsOverlay) {
                closeDialog();
            }
        });

        // Upload Profile Image
        uploadBtn.addEventListener('click', function() {
            profileImageInput.click();
        });

        profileImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // ตรวจสอบขนาดไฟล์ (ไม่เกิน 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showMessage('error', 'ขนาดไฟล์ใหญ่เกินไป กรุณาเลือกไฟล์ที่มีขนาดไม่เกิน 2MB');
                    return;
                }

                // ตรวจสอบประเภทไฟล์
                if (!file.type.startsWith('image/')) {
                    showMessage('error', 'กรุณาเลือกไฟล์รูปภาพเท่านั้น');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePreview.innerHTML = `<img src="${e.target.result}" alt="Profile">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Submit Form
        settingsForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const adminName = document.getElementById('adminName').value.trim();
            const greetingMessage = document.getElementById('greetingMessage').value.trim();
            const profileImage = profileImageInput.files[0];

            // Validation
            if (!adminName) {
                showMessage('error', 'กรุณากรอกชื่อแอดมิน');
                return;
            }

            if (!greetingMessage) {
                showMessage('error', 'กรุณากรอกข้อความต้อนรับ');
                return;
            }

            // แสดงข้อความกำลังบันทึก
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';
            saveBtn.disabled = true;

            try {
                // บันทึกข้อมูลผ่าน API
                await saveSettingsToAPI(adminName, greetingMessage, profileImage);

                // อัปเดตชื่อแอดมินในระบบ
                if (window.adminState) {
                    window.adminState.adminInfo.name = adminName;
                }

                showMessage('success', 'บันทึกการตั้งค่าเรียบร้อยแล้ว');

                // ปิด dialog หลังจาก 2 วินาที
                setTimeout(() => {
                    closeDialog();
                }, 2000);

            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('error', error.message || 'เกิดข้อผิดพลาดในการบันทึก กรุณาลองใหม่อีกครั้ง');
            } finally {
                // คืนค่าปุ่มบันทึก
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        });

        // แสดงข้อความ
        function showMessage(type, text) {
            hideMessages();

            const messageElement = type === 'success' ? successMessage : errorMessage;
            messageElement.querySelector('span').textContent = text;
            messageElement.classList.add('show');

            // ซ่อนข้อความหลังจาก 5 วินาที
            setTimeout(() => {
                messageElement.classList.remove('show');
            }, 5000);
        }

        // ซ่อนข้อความทั้งหมด
        function hideMessages() {
            successMessage.classList.remove('show');
            errorMessage.classList.remove('show');
        }

        // โหลดข้อมูลที่บันทึกไว้
        function loadSavedSettings() {
            try {
                const savedSettings = localStorage.getItem('adminSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    document.getElementById('adminName').value = settings.adminName || '';
                    document.getElementById('greetingMessage').value = settings.greetingMessage || '';

                    if (settings.profileImage) {
                        profilePreview.innerHTML = settings.profileImage;
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // โหลดข้อมูลจาก API
        async function loadSettingsFromAPI() {
            try {
                // แสดงสถานะโหลด
                showMessage('success', 'กำลังโหลดข้อมูล...');

                const apiBaseUrl = window.env?.BASE_API_URL || 'https://ownwebdev1.livinginsider.com/api/v1';
                const apiToken = window.env?.TOKEN_API || 'b059a15197926350fb43271477779d0fc04f6a4701eb3367c999c59eeae1f890';
                const webId = window.adminState?.currentWebId || '001';

                const response = await fetch(`${apiBaseUrl}/chat/greeting`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Settings data from API:', data);

                if (data.result_code === 1 && data.data) {
                    // อัปเดต UI ด้วยข้อมูลจาก API
                    if (data.data.bot_name) {
                        document.getElementById('adminName').value = data.data.bot_name;
                    }

                    if (data.data.greeting_detail) {
                        document.getElementById('greetingMessage').value = data.data.greeting_detail;
                    }

                    if (data.data.bot_image) {
                        profilePreview.innerHTML = `<img src="${data.data.bot_image}" alt="Profile">`;
                    }

                    hideMessages();
                } else {
                    console.log('No settings found in API, using default values');
                    hideMessages();
                }

            } catch (error) {
                console.error('Error loading settings from API:', error);
                hideMessages();
                // ไม่แสดง error เพราะอาจยังไม่มีข้อมูลใน API
            }
        }

        // บันทึกข้อมูลไปยัง API
        async function saveSettingsToAPI(adminName, greetingDetail, profileImageFile) {
            try {
                const apiBaseUrl = window.env?.BASE_API_URL || 'https://ownwebdev1.livinginsider.com/api/v1';
                const apiToken = window.env?.TOKEN_API || 'b059a15197926350fb43271477779d0fc04f6a4701eb3367c999c59eeae1f890';
                const webId = window.adminState?.currentWebId || '001';

                // สร้าง FormData สำหรับส่งข้อมูล
                const formData = new FormData();
                formData.append('web_id', webId);
                formData.append('bot_name', adminName);
                formData.append('greeting_detail', greetingDetail);

                // เพิ่มไฟล์รูปภาพ (ถ้ามี)
                if (profileImageFile) {
                    formData.append('bot_photo', profileImageFile);
                }

                const response = await fetch(`${apiBaseUrl}/chat/greeting`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                        // ไม่ต้องตั้ง Content-Type เพราะ FormData จะจัดการเอง
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Save settings response:', data);

                if (data.result_code === 1) {
                    // บันทึกข้อมูลไว้ใน localStorage เป็น backup
                    const settingsData = {
                        adminName: adminName,
                        greetingMessage: greetingDetail,
                        profileImage: profileImageFile ? profilePreview.innerHTML : null,
                        savedAt: new Date().toISOString()
                    };
                    localStorage.setItem('adminSettings', JSON.stringify(settingsData));

                    return data;
                } else {
                    throw new Error(data.sms || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }

            } catch (error) {
                console.error('Error saving settings to API:', error);
                throw error;
            }
        }
    });
</script>
</body>
</html>
